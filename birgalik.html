<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tezkor Quiz - Firebase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.0/lottie.min.js"></script>
  <style>
    :root {
      --primary-color: #506eec;
      --secondary-color: #f5f7fb;
      --text-color: #333;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --background-color: #f5f7fb;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-color);
      overflow-x: hidden;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-section {
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-container {
      text-align: center;
      margin-bottom: 30px;
    }

    .app-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 32px;
      font-weight: bold;
      color: var(--primary-color);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .logo-icon {
      font-size: 40px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(80, 110, 236, 0.1);
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary:hover {
      background-color: #3f5ac5;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(80, 110, 236, 0.3);
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .alert-box {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }

    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background-color: var(--primary-color);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      justify-content: center;
      transition: all 0.3s;
    }

    .file-upload-label:hover {
      background-color: #3f5ac5;
    }

    .file-upload-input {
      display: none;
    }

    .file-name {
      margin-top: 8px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }

    .group-code-display {
      background-color: rgba(80, 110, 236, 0.1);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
    }

    .group-code {
      font-size: 32px;
      font-weight: bold;
      color: var(--primary-color);
      letter-spacing: 5px;
      user-select: all;
    }

    .members-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .member-name {
      flex: 1;
      font-weight: 600;
    }

    .member-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      background-color: var(--correct-color);
      color: #fff;
    }

    .question-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .question-header {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .option-item:hover {
      background-color: #f5f7fb;
      border-color: var(--primary-color);
    }

    .option-item.selected {
      background-color: rgba(80, 110, 236, 0.1);
      border-color: var(--primary-color);
    }

    .option-item.correct {
      border-color: var(--correct-color);
      background-color: rgba(40, 167, 69, 0.1);
    }

    .option-item.incorrect {
      border-color: var(--incorrect-color);
      background-color: rgba(220, 53, 69, 0.1);
    }

    .custom-radio {
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .custom-radio.selected {
      border-color: var(--primary-color);
      background-color: var(--primary-color);
    }

    .custom-radio.selected::after {
      content: '';
      width: 8px;
      height: 8px;
      background-color: #fff;
      border-radius: 50%;
    }

    .quiz-timer {
      background-color: var(--primary-color);
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    .results-container {
      text-align: center;
    }

    .score-display {
      font-size: 48px;
      font-weight: bold;
      color: var(--primary-color);
      margin: 20px 0;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .leaderboard-table th {
      background-color: var(--primary-color);
      color: #fff;
    }

    .highlight-row {
      background-color: rgba(80, 110, 236, 0.1);
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    #lottieAnimation {
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(80, 110, 236, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <div class="app-logo">
        <i class="fas fa-lightbulb logo-icon"></i>
        <span>Tezkor Quiz</span>
      </div>
    </div>

    <!-- Loading Page -->
    <div id="loadingPage" class="page-section">
      <div style="text-align: center;">
        <div class="loading-spinner" style="margin: 20px auto;"></div>
        <p>Yuklanmoqda...</p>
      </div>
    </div>

    <!-- Welcome Page -->
    <div id="welcomePage" class="page-section hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="user-avatar" id="userAvatar"></div>
          <div>
            <div style="font-weight: bold;" id="userName"></div>
            <div style="font-size: 14px; color: #666;" id="userEmail"></div>
          </div>
        </div>
        <button id="logoutBtn" class="btn-secondary" style="width: auto;">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>

      <h3 class="text-center mb-4">Xush kelibsiz!</h3>
      <button id="createGroupBtn" class="btn-primary mb-3">
        <i class="fas fa-plus-circle"></i> Guruh yaratish
      </button>
      <button id="joinGroupBtn" class="btn-primary mb-3">
        <i class="fas fa-users"></i> Guruhga qo'shilish
      </button>
    </div>

    <!-- Create Group Page -->
    <div id="createGroupPage" class="page-section hidden">
      <h3 class="text-center mb-4">Guruh yaratish</h3>
      <div id="createAlert" class="alert-box"></div>
      <input type="text" id="groupName" class="form-input" placeholder="Guruh nomi">
      <div class="mb-3">
        <label for="questionFile" class="file-upload-label">
          <i class="fas fa-upload"></i> Savollar faylini yuklash (TXT)
        </label>
        <input type="file" id="questionFile" accept=".txt" class="file-upload-input">
        <div id="fileName" class="file-name">Fayl tanlanmadi</div>
      </div>
      <button id="createGroupSubmitBtn" class="btn-primary">
        <i class="fas fa-check"></i> Guruh yaratish
      </button>
      <button id="backFromCreateBtn" class="btn-secondary mt-2">
        <i class="fas fa-arrow-left"></i> Orqaga
      </button>
    </div>

    <!-- Join Group Page -->
    <div id="joinGroupPage" class="page-section hidden">
      <h3 class="text-center mb-4">Guruhga qo'shilish</h3>
      <div id="joinAlert" class="alert-box"></div>
      <input type="text" id="groupCode" class="form-input" placeholder="Guruh kodini kiriting" maxlength="6">
      <button id="joinGroupSubmitBtn" class="btn-primary">
        <i class="fas fa-sign-in-alt"></i> Qo'shilish
      </button>
      <button id="backFromJoinBtn" class="btn-secondary mt-2">
        <i class="fas fa-arrow-left"></i> Orqaga
      </button>
    </div>

    <!-- Waiting Room Page -->
    <div id="waitingRoomPage" class="page-section hidden">
      <h3 class="text-center mb-4">Kutish xonasi</h3>
      <div class="group-code-display">
        <p>Guruh kodi:</p>
        <div class="group-code" id="displayGroupCode"></div>
        <button id="copyCodeBtn" class="btn-secondary mt-2">
          <i class="fas fa-copy"></i> Nusxalash
        </button>
      </div>
      <h5>Ishtirokchilar (<span id="memberCount">0</span>):</h5>
      <div class="members-list" id="membersList"></div>
      <button id="startQuizBtn" class="btn-primary hidden">
        <i class="fas fa-play"></i> Quizni boshlash
      </button>
      <button id="leaveGroupBtn" class="btn-secondary mt-2">
        <i class="fas fa-door-open"></i> Guruhdan chiqish
      </button>
    </div>

    <!-- Quiz Page -->
    <div id="quizPage" class="page-section hidden">
      <div class="quiz-timer">
        <i class="fas fa-clock"></i> <span id="quizTimer">00:00</span>
      </div>
      <div id="questionsContainer"></div>
      <button id="submitQuizBtn" class="btn-primary">
        <i class="fas fa-check-circle"></i> Yakunlash
      </button>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="page-section hidden">
      <div id="lottieAnimation"></div>
      <h3 class="text-center">Tabriklaymiz!</h3>
      <div class="score-display">
        <span id="userScore">0</span>/<span id="totalQuestions">0</span>
      </div>
      <p class="text-center">To'g'ri javoblar: <strong id="correctCount">0</strong></p>
      <p class="text-center">Noto'g'ri javoblar: <strong id="incorrectCount">0</strong></p>
      
      <h4 class="mt-4">
        <i class="fas fa-trophy"></i> Peshqadamlar jadvali
      </h4>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>O'rin</th>
            <th>Ism</th>
            <th>Ball</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
      
      <button id="backToWelcomeBtn" class="btn-primary mt-4">
        <i class="fas fa-home"></i> Bosh sahifaga
      </button>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBxIpLY5WasiSIlDL4japBLnnXRwOLUKEQ",
      authDomain: "tezkorquiz.uz",
      projectId: "tezkor-quiz-bbe3c",
      storageBucket: "tezkor-quiz-bbe3c.firebasestorage.app",
      messagingSenderId: "143161522496",
      appId: "1:143161522496:web:252108ace3a4c19f35e2a5",
    };

    // Firebase import
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteField } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase initialization
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let currentGroupId = null;
    let unsubscribeGroup = null;
    let quizTimer = null;
    let quizStartTime = null;

    // DOM elements
    const pages = {
      loading: document.getElementById('loadingPage'),
      welcome: document.getElementById('welcomePage'),
      createGroup: document.getElementById('createGroupPage'),
      joinGroup: document.getElementById('joinGroupPage'),
      waitingRoom: document.getElementById('waitingRoomPage'),
      quiz: document.getElementById('quizPage'),
      results: document.getElementById('resultsPage')
    };

    // Show specific page
    function showPage(pageName) {
      Object.values(pages).forEach(page => page.classList.add('hidden'));
      pages[pageName].classList.remove('hidden');
    }

    // Show alert
    function showAlert(elementId, message, type) {
      const alertBox = document.getElementById(elementId);
      alertBox.textContent = message;
      alertBox.className = `alert-box alert-${type}`;
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 3000);
    }

    // Auth state observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
        showPage('welcome');
      } else {
        // Redirect to kirish.html if not logged in
        window.location.href = 'kirish.html';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Chiqishda xatolik:', error);
      }
    });

    // Create Group
    document.getElementById('createGroupBtn').addEventListener('click', () => {
      showPage('createGroup');
    });

    document.getElementById('backFromCreateBtn').addEventListener('click', () => {
      showPage('welcome');
    });

    // File upload
    document.getElementById('questionFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('fileName').textContent = file.name;
      }
    });

    // Parse questions from TXT
    function parseQuestions(text) {
      const lines = text.split('\n');
      const questions = [];
      let currentQuestion = null;

      lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        if (!line.startsWith('A.') && !line.startsWith('B.') && !line.startsWith('C.') && !line.startsWith('D.') && !line.startsWith('ANSWER:')) {
          if (currentQuestion) questions.push(currentQuestion);
          currentQuestion = {
            id: questions.length + 1,
            text: line,
            options: [],
            correctAnswer: null
          };
        } else if (line.startsWith('ANSWER:')) {
          const answer = line.split('ANSWER:')[1].trim();
          const map = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
          currentQuestion.correctAnswer = map[answer];
        } else {
          currentQuestion.options.push(line.substring(2).trim());
        }
      });

      if (currentQuestion) questions.push(currentQuestion);
      return questions;
    }

    // Generate group code
    function generateGroupCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    // Create group submit
    document.getElementById('createGroupSubmitBtn').addEventListener('click', async () => {
      const groupName = document.getElementById('groupName').value.trim();
      const file = document.getElementById('questionFile').files[0];

      if (!groupName || !file) {
        showAlert('createAlert', 'Guruh nomi va savollar faylini kiriting!', 'error');
        return;
      }

      try {
        const text = await file.text();
        const questions = parseQuestions(text);

        if (questions.length === 0) {
          showAlert('createAlert', 'Savollar topilmadi!', 'error');
          return;
        }

        const groupCode = generateGroupCode();
        const groupRef = doc(db, 'groups', groupCode);

        await setDoc(groupRef, {
          code: groupCode,
          name: groupName,
          ownerId: currentUser.uid,
          createdAt: new Date().toISOString(),
          questions: questions,
          isStarted: false,
          members: {
            [currentUser.uid]: {
              name: currentUser.displayName || currentUser.email.split('@')[0],
              email: currentUser.email,
              joinedAt: new Date().toISOString(),
              score: 0,
              answers: []
            }
          }
        });

        currentGroupId = groupCode;
        showWaitingRoom(groupCode);
      } catch (error) {
        showAlert('createAlert', 'Xatolik: ' + error.message, 'error');
      }
    });

    // Join Group
    document.getElementById('joinGroupBtn').addEventListener('click', () => {
      showPage('joinGroup');
    });

    document.getElementById('backFromJoinBtn').addEventListener('click', () => {
      showPage('welcome');
    });

    document.getElementById('joinGroupSubmitBtn').addEventListener('click', async () => {
      const code = document.getElementById('groupCode').value.trim().toUpperCase();

      if (!code) {
        showAlert('joinAlert', 'Guruh kodini kiriting!', 'error');
        return;
      }

      try {
        const groupRef = doc(db, 'groups', code);
        const groupSnap = await getDoc(groupRef);

        if (!groupSnap.exists()) {
          showAlert('joinAlert', 'Guruh topilmadi!', 'error');
          return;
        }

        const groupData = groupSnap.data();

        if (groupData.isStarted) {
          showAlert('joinAlert', 'Quiz allaqachon boshlangan!', 'error');
          return;
        }

        await updateDoc(groupRef, {
          [`members.${currentUser.uid}`]: {
            name: currentUser.displayName || currentUser.email.split('@')[0],
            email: currentUser.email,
            joinedAt: new Date().toISOString(),
            score: 0,
            answers: []
          }
        });

        currentGroupId = code;
        showWaitingRoom(code);
      } catch (error) {
        showAlert('joinAlert', 'Xatolik: ' + error.message, 'error');
      }
    });

    // Show waiting room
    function showWaitingRoom(groupCode) {
      showPage('waitingRoom');
      document.getElementById('displayGroupCode').textContent = groupCode;

      const groupRef = doc(db, 'groups', groupCode);
      unsubscribeGroup = onSnapshot(groupRef, (snapshot) => {
        const data = snapshot.data();
        if (!data) return;

        const members = Object.values(data.members);
        document.getElementById('memberCount').textContent = members.length;

        const membersList = document.getElementById('membersList');
        membersList.innerHTML = '';

        members.forEach(member => {
          const div = document.createElement('div');
          div.className = 'member-item';
          div.innerHTML = `
            <div class="member-avatar">${member.name.charAt(0).toUpperCase()}</div>
            <div class="member-name">${member.name}</div>
            <div class="member-status">Tayyor</div>
          `;
          membersList.appendChild(div);
        });

        if (data.ownerId === currentUser.uid) {
          document.getElementById('startQuizBtn').classList.remove('hidden');
        }

        if (data.isStarted) {
          startQuiz(data.questions);
        }
      });
    }

    // Copy group code
    document.getElementById('copyCodeBtn').addEventListener('click', () => {
      const code = document.getElementById('displayGroupCode').textContent;
      navigator.clipboard.writeText(code);
      showAlert('joinAlert', 'Kod nusxalandi!', 'success');
    });

    // Start Quiz
    document.getElementById('startQuizBtn').addEventListener('click', async () => {
      if (!currentGroupId) return;

      try {
        const groupRef = doc(db, 'groups', currentGroupId);
        await updateDoc(groupRef, {
          isStarted: true,
          startedAt: new Date().toISOString()
        });
      } catch (error) {
        console.error('Quiz boshlashda xatolik:', error);
      }
    });

    // Leave group
    document.getElementById('leaveGroupBtn').addEventListener('click', async () => {
      if (!currentGroupId) return;

      try {
        const groupRef = doc(db, 'groups', currentGroupId);
        await updateDoc(groupRef, {
          [`members.${currentUser.uid}`]: deleteField()
        });

        if (unsubscribeGroup) unsubscribeGroup();
        currentGroupId = null;
        showPage('welcome');
      } catch (error) {
        console.error('Guruhdan chiqishda xatolik:', error);
      }
    });

    // Start Quiz Display
    function startQuiz(questions) {
      showPage('quiz');
      
      quizStartTime = Date.now();
      quizTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('quizTimer').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);

      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      questions.forEach((question, qIndex) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-container';
        questionDiv.innerHTML = `
          <div class="question-header">${qIndex + 1}. ${question.text}</div>
          <div class="options-container" data-question-index="${qIndex}">
            ${question.options.map((option, oIndex) => `
              <div class="option-item" data-option-index="${oIndex}">
                <div class="custom-radio"></div>
                <div style="flex: 1;">${option}</div>
              </div>
            `).join('')}
          </div>
        `;
        container.appendChild(questionDiv);

        const optionsContainer = questionDiv.querySelector('.options-container');
        const optionItems = optionsContainer.querySelectorAll('.option-item');

        optionItems.forEach(item => {
          item.addEventListener('click', () => {
            optionItems.forEach(opt => {
              opt.classList.remove('selected');
              opt.querySelector('.custom-radio').classList.remove('selected');
            });
            
            item.classList.add('selected');
            item.querySelector('.custom-radio').classList.add('selected');
          });
        });
      });
    }

    // Submit Quiz
    document.getElementById('submitQuizBtn').addEventListener('click', async () => {
      if (!currentGroupId) return;

      clearInterval(quizTimer);

      try {
        const groupRef = doc(db, 'groups', currentGroupId);
        const groupSnap = await getDoc(groupRef);
        const questions = groupSnap.data().questions;

        const answers = [];
        let score = 0;

        questions.forEach((question, qIndex) => {
          const optionsContainer = document.querySelector(`[data-question-index="${qIndex}"]`);
          const selectedOption = optionsContainer.querySelector('.option-item.selected');
          
          if (selectedOption) {
            const selectedIndex = parseInt(selectedOption.dataset.optionIndex);
            answers.push(selectedIndex);

            if (selectedIndex === question.correctAnswer) {
              score++;
              selectedOption.classList.add('correct');
            } else {
              selectedOption.classList.add('incorrect');
              const correctOption = optionsContainer.querySelector(`[data-option-index="${question.correctAnswer}"]`);
              correctOption.classList.add('correct');
            }
          } else {
            answers.push(-1);
          }
        });

        await updateDoc(groupRef, {
          [`members.${currentUser.uid}.answers`]: answers,
          [`members.${currentUser.uid}.score`]: score,
          [`members.${currentUser.uid}.finishedAt`]: new Date().toISOString()
        });

        setTimeout(() => {
          showResults(score, questions.length);
        }, 2000);

      } catch (error) {
        console.error('Natijalarni saqlashda xatolik:', error);
      }
    });

    // Show Results
    async function showResults(userScore, totalQuestions) {
      showPage('results');

      const correctCount = userScore;
      const incorrectCount = totalQuestions - userScore;

      document.getElementById('userScore').textContent = userScore;
      document.getElementById('totalQuestions').textContent = totalQuestions;
      document.getElementById('correctCount').textContent = correctCount;
      document.getElementById('incorrectCount').textContent = incorrectCount;

      // Lottie animation
      const percentage = (userScore / totalQuestions) * 100;
      let animationPath;
      
      if (percentage >= 80) {
        animationPath = 'https://assets6.lottiefiles.com/packages/lf20_touohxv0.json';
      } else if (percentage >= 50) {
        animationPath = 'https://assets7.lottiefiles.com/private_files/lf30_poez9ped.json';
      } else {
        animationPath = 'https://assets9.lottiefiles.com/private_files/lf30_ulp9xqqw.json';
      }

      lottie.loadAnimation({
        container: document.getElementById('lottieAnimation'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: animationPath
      });

      // Load leaderboard
      try {
        const groupRef = doc(db, 'groups', currentGroupId);
        const groupSnap = await getDoc(groupRef);
        const members = groupSnap.data().members;

        const leaderboard = Object.entries(members)
          .map(([uid, data]) => ({
            name: data.name,
            score: data.score || 0,
            isCurrentUser: uid === currentUser.uid
          }))
          .sort((a, b) => b.score - a.score);

        const leaderboardBody = document.getElementById('leaderboardBody');
        leaderboardBody.innerHTML = '';

        leaderboard.forEach((user, index) => {
          const row = document.createElement('tr');
          if (user.isCurrentUser) row.className = 'highlight-row';

          const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : index + 1;

          row.innerHTML = `
            <td style="text-align: center;">${medal}</td>
            <td>${user.name}</td>
            <td style="text-align: center; font-weight: bold;">${user.score}</td>
          `;
          leaderboardBody.appendChild(row);
        });

      } catch (error) {
        console.error('Leaderboard yuklashda xatolik:', error);
      }
    }

    // Back to welcome
    document.getElementById('backToWelcomeBtn').addEventListener('click', () => {
      if (unsubscribeGroup) unsubscribeGroup();
      currentGroupId = null;
      showPage('welcome');
    });
  </script>
</body>
</html>
