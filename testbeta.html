<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="aga/iconcha.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tezkor Quiz - Test yaratish</title>
  <style>
    :root {
      --primary-color: #4560e5;
      --bg-color: #ffffff;
      --text-color: #333333;
      --light-gray: #f5f7ff;
      --border-color: #e0e4f5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      background-color: #ededf7;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 0;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(69, 96, 229, 0.2);
    }

    header h1 {
      text-align: center;
    }

    .form-container {
      background-color: var(--bg-color);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .quiz-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 600;
      color: var(--text-color);
    }

    input, textarea, select {
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(69, 96, 229, 0.2);
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #3a51c1;
    }

    button:active {
      transform: translateY(1px);
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option input[type="radio"] {
      width: 20px;
      height: 20px;
    }

    .option input[type="text"] {
      flex-grow: 1;
    }

    .add-btn {
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 5px;
      background-color: #f0f3ff;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    .add-btn:hover {
      background-color: #e5eaff;
    }

    .remove-btn {
      background-color: rgba(255, 77, 77, 0.1);
      color: #ff4d4d;
      border: 1px solid #ff4d4d;
      padding: 8px 12px;
    }

    .remove-btn:hover {
      background-color: rgba(255, 77, 77, 0.2);
    }

    .preview-container {
      background-color: var(--light-gray);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .preview-container h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question-preview {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .question-text {
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .option-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .option-preview:hover {
      background-color: var(--light-gray);
    }

    .correct {
      background-color: rgba(76, 175, 80, 0.1);
      border: 1px solid #4caf50;
    }

    .quiz-list {
      list-style: none;
    }

    .quiz-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quiz-item:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .edit-btn {
      background-color: #ffc107;
      color: #333;
    }

    .edit-btn:hover {
      background-color: #e5ac06;
    }

    .error {
      color: #ff4d4d;
      font-size: 14px;
      margin-top: 5px;
    }

    .tab-container {
      margin-bottom: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      background-color: var(--light-gray);
      border-radius: 6px 6px 0 0;
      cursor: pointer;
    }

    .tab.active {
      background-color: var(--primary-color);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .success-message {
      background-color: rgba(76, 175, 80, 0.1);
      color: #4caf50;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #4caf50;
    }
    
    .error-message {
      background-color: rgba(255, 77, 77, 0.1);
      color: #ff4d4d;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #ff4d4d;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .loading::after {
      content: "";
      width: 30px;
      height: 30px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .download-btn {
      background-color: #28a745;
      color: white;
    }

    .download-btn:hover {
      background-color: #218838;
    }

    .finish-test-btn {
      background-color: #17a2b8;
      color: white;
      margin-top: 10px;
    }

    .finish-test-btn:hover {
      background-color: #138496;
    }

    .test-group {
      background-color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .test-header {
      background-color: var(--light-gray);
      padding: 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
    }

    .test-header-actions {
      display: flex;
      gap: 10px;
    }

    /* Accordion kodlari bu yerdan boshlandi */
    .shortcuts-info-container {
      background-color: var(--bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .shortcuts-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3a51c1 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    
    .shortcuts-header:hover {
      background: linear-gradient(135deg, #3a51c1 0%, #2d3f99 100%);
    }
    
    .shortcuts-header span {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .shortcuts-arrow {
      transition: transform 0.3s ease;
    }
    
    .shortcuts-header.active .shortcuts-arrow {
      transform: rotate(180deg);
    }
    
    .shortcuts-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.4s ease;
      background-color: var(--bg-color);
    }
    
    .shortcuts-content.active {
      max-height: 600px;
      padding: 20px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .shortcut-item {
      background-color: var(--light-gray);
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .shortcut-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(69, 96, 229, 0.15);
    }
    
    .shortcut-keys {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .shortcut-keys kbd {
      background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
      border: 1px solid #d1d5db;
      border-bottom: 3px solid #9ca3af;
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      min-width: 28px;
      text-align: center;
    }
    
    .shortcut-desc {
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.4;
    }
    
    .shortcuts-tip {
      background-color: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #ffc107;
      padding: 12px 15px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .shortcuts-tip strong {
      color: #f59e0b;
    }
    
    /* Mobil moslashtirish */
    @media (max-width: 768px) {
      .shortcuts-grid {
        grid-template-columns: 1fr;
      }
      
      .shortcuts-header span {
        font-size: 14px;
      }
      
      .shortcut-keys {
        flex-wrap: wrap;
      }
      
      .shortcut-keys kbd {
        font-size: 11px;
        padding: 2px 5px;
        min-width: 24px;
      }
      
      .shortcut-desc {
        font-size: 12px;
        word-wrap: break-word;
      }
      
      .shortcuts-tip {
        font-size: 12px;
        padding: 10px 12px;
      }
      
      .shortcuts-content.active {
        max-height: 800px;
        overflow-y: auto;
        scroll-behavior: smooth;
      }
      
      .shortcut-item {
        padding: 12px;
      }
      
      .option input[type="text"] {
        font-size: 13px;
      }
    }
    
    /* Animatsiya effektlari */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .shortcuts-content.active .shortcut-item {
      animation: slideIn 0.4s ease forwards;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(1) {
      animation-delay: 0.05s;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(2) {
      animation-delay: 0.1s;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(3) {
      animation-delay: 0.15s;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(4) {
      animation-delay: 0.2s;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(5) {
      animation-delay: 0.25s;
    }
    
    .shortcuts-content.active .shortcut-item:nth-child(6) {
      animation-delay: 0.3s;
    }

    /* Bu joydan accordion tugadi */

    .test-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .test-content.active {
      max-height: 1000px;
      padding: 15px;
    }

    .question-list {
      list-style-type: decimal;
      padding-left: 20px;
    }

    .question-list li {
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--light-gray);
      border-radius: 5px;
      animation: fadeIn 0.5s ease-out;
    }

    .question-list li.removing {
      animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    .active-test-info {
      background-color: rgba(69, 96, 229, 0.1);
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .active-test-name {
      font-weight: 600;
      color: var(--primary-color);
    }

    .message-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 300px;
    }
    
    .added-question {
      animation: slideDown 0.5s ease-out;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .test-name-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .test-name-display {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .hidden {
      display: none !important;
    }
    
    .preview-questions {
      margin-top: 15px;
    }
    
    .preview-question-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0); }
      90% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
  </style>
</head>
<body>
<br>
  <div class="container">
    <header>
      <h1>Tezkor test qo'shish</h1>
    </header>

    <div class="message-container" id="messageContainer"></div>
    
    <!-- Tezkor klavishlar info paneli -->
    <div class="shortcuts-info-container">
      <div class="shortcuts-header" id="shortcutsHeader">
        <span>‚å®Ô∏è Tezkor klavishlar</span>
        <svg class="shortcuts-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
        </svg>
      </div>
      
      <div class="shortcuts-content" id="shortcutsContent">
        <div class="shortcuts-grid">
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Alt</kbd> + <kbd>N</kbd>
            </div>
            <div class="shortcut-desc">Test nomi maydoniga o'tish</div>
          </div>
          
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Alt</kbd> + <kbd>Q</kbd>
            </div>
            <div class="shortcut-desc">Savol maydoniga o'tish</div>
          </div>
          
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Alt</kbd> + <kbd>1</kbd>-<kbd>4</kbd>
            </div>
            <div class="shortcut-desc">Variant maydonlariga o'tish</div>
          </div>
          
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>1</kbd>-<kbd>4</kbd>
            </div>
            <div class="shortcut-desc">To'g'ri javobni belgilash</div>
          </div>
          
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Alt</kbd> + <kbd>S</kbd>
            </div>
            <div class="shortcut-desc">Savolni saqlash</div>
          </div>
          
          <div class="shortcut-item">
            <div class="shortcut-keys">
              <kbd>Tab</kbd>
            </div>
            <div class="shortcut-desc">Keyingi maydoniga o'tish</div>
          </div>
        </div>
        
        <div class="shortcuts-tip">
          üí° <strong>Maslahat:</strong> Tez ishlash uchun tezkor tugmalardan foydalaning
        </div>
      </div>
    </div>

    <div class="tab-container">
      <div class="tabs">
        <div class="tab active" data-tab="create">Savol yaratish</div>
        <div class="tab" data-tab="list">Testlar ro'yxati</div>
      </div>
    </div>

    <div id="create-tab" class="tab-content active">
      <div id="activeTestInfo" class="active-test-info hidden">
        <div class="test-name-container">
          <span>Joriy test:</span>
          <span class="active-test-name" id="activeTestName"></span>
        </div>
        <button id="finishTestBtn" class="finish-test-btn">Testni yakunlash</button>
      </div>
      
      <div class="form-container">
        <h2>Yangi test qo'shish</h2>
        <form class="quiz-form" id="quizForm">
          <div id="testNameGroup" class="form-group">
            <label for="testName">Test nomi <span style="color: #999; font-size: 12px; font-weight: normal; margin-left: 8px;">(Alt + N)</span></label>
            <input type="text" id="testName" placeholder="Test nomini kiriting" required>
            <div id="testNameError" class="error"></div>
          </div>

          <div class="form-group">
            <label for="question">Savol matni <span style="color: #999; font-size: 12px; font-weight: normal; margin-left: 8px;">(Alt + Q)</span></label>
            <textarea id="question" rows="3" placeholder="Savolingizni kiriting" required></textarea>
            <div id="questionError" class="error"></div>
          </div>

          <div class="form-group">
            <label>Javob variantlari <span style="color: #999; font-size: 12px; font-weight: normal; margin-left: 8px;">To'g'ri javob: Ctrl + Alt + 1-4</span></label>
            <select id="optionCountSelect">
              <option value="2">2 ta variant</option>
              <option value="3">3 ta variant</option>
              <option value="4" selected>4 ta variant</option>
            </select>
            <div class="options-container" id="optionsContainer">
              <div class="option">
                <input type="radio" name="correctAnswer" value="0" required>
                <input type="text" placeholder="Variant 1 (Alt+1)" required>
              </div>
              <div class="option">
                <input type="radio" name="correctAnswer" value="1">
                <input type="text" placeholder="Variant 2 (Alt+2)" required>
              </div>
              <div class="option">
                <input type="radio" name="correctAnswer" value="2">
                <input type="text" placeholder="Variant 3 (Alt+3)" required>
              </div>
              <div class="option">
                <input type="radio" name="correctAnswer" value="3">
                <input type="text" placeholder="Variant 4 (Alt+4)" required>
              </div>
            </div>
            <div id="optionsError" class="error"></div>
          </div>

          <button type="submit" id="submitBtn">Saqlash</button>
        </form>
      </div>

      <div class="preview-container">
        <h2>
          <span>Oldindan ko'rish</span>
          <span id="previewTestName" class="test-name-display"></span>
        </h2>
        <div class="question-preview" id="questionPreview">
          <div class="question-text">Savol matni bu yerda ko'rinadi</div>
          <div id="optionsPreview">
            <div class="option-preview">
              <input type="radio" name="previewOption" disabled>
              <span>Variant 1</span>
            </div>
            <div class="option-preview">
              <input type="radio" name="previewOption" disabled>
              <span>Variant 2</span>
            </div>
            <div class="option-preview">
              <input type="radio" name="previewOption" disabled>
              <span>Variant 3</span>
            </div>
            <div class="option-preview">
              <input type="radio" name="previewOption" disabled>
              <span>Variant 4</span>
            </div>
          </div>
        </div>
        
        <div class="preview-questions" id="previewQuestions">
          <!-- Saqlangan savollar ro'yxati -->
        </div>
      </div>
    </div>

    <div id="list-tab" class="tab-content">
      <div class="form-container">
        <div class="list-header">
          <h2>Testlar ro'yxati</h2>
        </div>
        <div id="quizListLoader" class="loading"></div>
        <div id="testGroups">
          <!-- Test guruhlar ro'yxati dinamik ravishda to'ldiriladi -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxIpLY5WasiSIlDL4japBLnnXRwOLUKEQ",
      authDomain: "tezkor-quiz-bbe3c.firebaseapp.com",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace(`/kirish.html?returnUrl=${returnUrl}`);
      } else {
        console.log("User logged in:", user.uid);
      }
    });
  </script>

  <script>
    const API_BASE_URL = 'http://localhost:3000/api/quizzes';
    const quizForm = document.getElementById('quizForm');
    const testNameInput = document.getElementById('testName');
    const testNameGroup = document.getElementById('testNameGroup');
    const questionInput = document.getElementById('question');
    const optionsContainer = document.getElementById('optionsContainer');
    const optionCountSelect = document.getElementById('optionCountSelect');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const submitBtn = document.getElementById('submitBtn');
    const finishTestBtn = document.getElementById('finishTestBtn');
    const testNameError = document.getElementById('testNameError');
    const questionError = document.getElementById('questionError');
    const optionsError = document.getElementById('optionsError');
    const questionPreview = document.querySelector('.question-text');
    const optionsPreview = document.getElementById('optionsPreview');
    const testGroups = document.getElementById('testGroups');
    const quizListLoader = document.getElementById('quizListLoader');
    const messageContainer = document.getElementById('messageContainer');
    const activeTestInfo = document.getElementById('activeTestInfo');
    const activeTestName = document.getElementById('activeTestName');
    const previewTestName = document.getElementById('previewTestName');
    const previewQuestions = document.getElementById('previewQuestions');
    const STORAGE_KEY = 'menda_quiz_items';
    const ACTIVE_TEST_KEY = 'menda_active_test';
    let quizItems = [];
    let activeTest = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadQuizItems();
      loadActiveTest();
      updateOptionIndexes();
      updatePreview();
      updateTestGroupList();
      document.querySelectorAll('.option input[type="text"]').forEach(input => {
        input.addEventListener('input', updatePreview);
      });
      adjustOptions(4); // Default 4 ta variant
    });

    // Tezkor klavishlar panelini boshqarish
    const shortcutsHeader = document.getElementById('shortcutsHeader');
    const shortcutsContent = document.getElementById('shortcutsContent');
    
    if (shortcutsHeader && shortcutsContent) {
      shortcutsHeader.addEventListener('click', () => {
        shortcutsHeader.classList.toggle('active');
        shortcutsContent.classList.toggle('active');
      });
    }

    // Joriy testni saqlash
    function saveActiveTest(testName) {
      activeTest = testName;
      localStorage.setItem(ACTIVE_TEST_KEY, testName);
      activeTestName.textContent = testName;
      previewTestName.textContent = testName;
      activeTestInfo.classList.remove('hidden');
      testNameGroup.classList.add('hidden');
      updatePreviewQuestions();
    }

    // Joriy testni yuklash
    function loadActiveTest() {
      const savedTest = localStorage.getItem(ACTIVE_TEST_KEY);
      if (savedTest) {
        saveActiveTest(savedTest);
        testNameInput.value = savedTest;
      }
    }

    // Testni yakunlash
    finishTestBtn.addEventListener('click', () => {
      activeTest = null;
      localStorage.removeItem(ACTIVE_TEST_KEY);
      activeTestInfo.classList.add('hidden');
      testNameGroup.classList.remove('hidden');
      testNameInput.value = '';
      previewTestName.textContent = '';
      previewQuestions.innerHTML = '';
      showMessage('Test yakunlandi!', 'success');
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${tabId}-tab`) {
            content.classList.add('active');
            if (tabId === 'list') {
              fetchQuestions();
            }
          }
        });
      });
    });

    optionCountSelect.addEventListener('change', (e) => {
      adjustOptions(parseInt(e.target.value));
    });

    function adjustOptions(count) {
      while (optionsContainer.children.length > count) {
        optionsContainer.lastChild.remove();
      }
      while (optionsContainer.children.length < count) {
        const optionIndex = optionsContainer.children.length;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        const radioInput = document.createElement('input');
        radioInput.type = 'radio';
        radioInput.name = 'correctAnswer';
        radioInput.value = optionIndex;
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.placeholder = `Variant ${optionIndex + 1} (Alt+${optionIndex + 1})`;
        textInput.required = true;
        optionDiv.appendChild(radioInput);
        optionDiv.appendChild(textInput);
        optionsContainer.appendChild(optionDiv);
        textInput.addEventListener('input', updatePreview);
      }
      updateOptionIndexes();
      updatePreview();
    }

    function updateOptionIndexes() {
      const options = optionsContainer.querySelectorAll('.option');
      options.forEach((option, index) => {
        const radio = option.querySelector('input[type="radio"]');
        radio.value = index;
        const textInput = option.querySelector('input[type="text"]');
        textInput.placeholder = `Variant ${index + 1} (Alt+${index + 1})`;
      });
    }

    function updatePreview() {
      questionPreview.textContent = questionInput.value || 'Savol matni bu yerda ko\'rinadi';
      optionsPreview.innerHTML = '';
      const options = optionsContainer.querySelectorAll('.option');
      options.forEach((option, index) => {
        const textInput = option.querySelector('input[type="text"]');
        const radioInput = option.querySelector('input[type="radio"]');
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-preview';
        if (radioInput.checked) {
          optionDiv.classList.add('correct');
        }
        const radioPreview = document.createElement('input');
        radioPreview.type = 'radio';
        radioPreview.name = 'previewOption';
        radioPreview.disabled = true;
        if (radioInput.checked) {
          radioPreview.checked = true;
        }
        const textSpan = document.createElement('span');
        textSpan.textContent = textInput.value || `Variant ${index + 1}`;
        optionDiv.appendChild(radioPreview);
        optionDiv.appendChild(textSpan);
        optionsPreview.appendChild(optionDiv);
      });
    }

    // Saqlangan savollar ro'yxatini yangilash
    function updatePreviewQuestions() {
      if (!activeTest) {
        previewQuestions.innerHTML = '';
        return;
      }
      
      const testQuestions = quizItems.filter(item => item.testName === activeTest);
      previewQuestions.innerHTML = '';
      
      if (testQuestions.length === 0) {
        return;
      }
      
      const questionsList = document.createElement('h3');
      questionsList.textContent = 'Saqlangan savollar:';
      questionsList.style.marginTop = '20px';
      questionsList.style.marginBottom = '10px';
      previewQuestions.appendChild(questionsList);
      
      testQuestions.forEach((item, index) => {
        const questionItem = document.createElement('div');
        questionItem.className = 'preview-question-item';
        
        const questionNumber = document.createElement('div');
        questionNumber.style.fontWeight = 'bold';
        questionNumber.textContent = `${index + 1}. ${item.question}`;
        
        const optionsList = document.createElement('div');
        optionsList.style.marginTop = '10px';
        
        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        item.options.forEach((option, optIndex) => {
          const optionItem = document.createElement('div');
          optionItem.style.margin = '5px 0';
          optionItem.innerHTML = `${letters[optIndex]}. ${option} ${optIndex === item.correctIndex ? '<strong>(‚úì)</strong>' : ''}`;
          optionsList.appendChild(optionItem);
        });
        
        questionItem.appendChild(questionNumber);
        questionItem.appendChild(optionsList);
        previewQuestions.appendChild(questionItem);
      });
    }

    questionInput.addEventListener('input', updatePreview);
    optionsContainer.addEventListener('change', (e) => {
      if (e.target.type === 'radio') {
        updatePreview();
      }
    });
    optionsContainer.addEventListener('input', (e) => {
      if (e.target.type === 'text') {
        updatePreview();
      }
    });

    quizForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateForm()) return;
      
      const formData = getFormData();
      
      try {
        await createQuizItem(formData);
        
        if (!activeTest) {
          saveActiveTest(formData.testName);
        }
        
        const newQuestion = document.createElement('div');
        newQuestion.className = 'preview-question-item added-question';
        newQuestion.innerHTML = `
          <div style="font-weight: bold">${formData.question}</div>
          <div style="margin-top: 10px;">Savol muvaffaqiyatli qo'shildi!</div>
        `;
        
        previewQuestions.appendChild(newQuestion);
        setTimeout(() => {
          updatePreviewQuestions();
        }, 1000);
        
        showMessage('Savol muvaffaqiyatli saqlandi!', 'success');
        resetFormExceptTestName();
      } catch (error) {
        showMessage(`Xatolik: ${error.message || 'Nomalum xatolik'}`, 'error');
      }
    });

    function validateForm() {
      let isValid = true;
      
      if (!activeTest && !testNameInput.value.trim()) {
        testNameError.textContent = 'Test nomini kiriting';
        isValid = false;
      } else {
        testNameError.textContent = '';
      }
      
      if (!questionInput.value.trim()) {
        questionError.textContent = 'Savol kiritilishi shart';
        isValid = false;
      } else {
        questionError.textContent = '';
      }
      
      const options = optionsContainer.querySelectorAll('.option');
      const optionValues = Array.from(options).map(option => 
        option.querySelector('input[type="text"]').value.trim()
      );
      
      if (optionValues.some(value => !value)) {
        optionsError.textContent = 'Barcha variantlarni to\'ldiring';
        isValid = false;
      } else if (new Set(optionValues).size !== optionValues.length) {
        optionsError.textContent = 'Variantlar takrorlanmasligi kerak';
        isValid = false;
      } else {
        optionsError.textContent = '';
      }
      
      const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
      if (!correctAnswer) {
        optionsError.textContent = 'To\'g\'ri javobni belgilang';
        isValid = false;
      }
      
      return isValid;
    }

    function getFormData() {
      const options = optionsContainer.querySelectorAll('.option');
      const optionValues = Array.from(options).map(option => 
        option.querySelector('input[type="text"]').value.trim()
      );
      const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
      
      return {
        id: Date.now(),
        testName: activeTest || testNameInput.value.trim(),
        question: questionInput.value.trim(),
        options: optionValues,
        correctIndex: parseInt(correctAnswer.value)
      };
    }

    function resetFormExceptTestName() {
      const testName = testNameInput.value;
      
      questionInput.value = '';
      document.querySelectorAll('.option input[type="text"]').forEach(input => {
        input.value = '';
      });
      document.querySelectorAll('.option input[type="radio"]').forEach((radio, index) => {
        radio.checked = index === 0;
      });
      
      testNameInput.value = testName;
      
      delete quizForm.dataset.editId;
      submitBtn.textContent = 'Saqlash';
      
      questionError.textContent = '';
      optionsError.textContent = '';
      
      updatePreview();
    }

    function resetForm() {
      quizForm.reset();
      delete quizForm.dataset.editId;
      adjustOptions(parseInt(optionCountSelect.value));
      submitBtn.textContent = 'Saqlash';
      questionError.textContent = '';
      optionsError.textContent = '';
      testNameError.textContent = '';
      updatePreview();
    }

    async function createQuizItem(formData) {
      try {
        quizItems.push(formData);
        saveQuizItems();
        return formData;
      } catch (error) {
        console.error('Error creating quiz item:', error);
        throw error;
      }
    }

    function saveQuizItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(quizItems));
    }

    function loadQuizItems() {
      const items = localStorage.getItem(STORAGE_KEY);
      quizItems = items ? JSON.parse(items) : [];
    }

    async function fetchQuestions() {
      quizListLoader.style.display = 'flex';
      try {
        await updateTestGroupList();
      } catch (error) {
        console.error('Error fetching questions:', error);
        showMessage('Savollarni yuklashda xatolik yuz berdi', 'error');
      } finally {
        quizListLoader.style.display = 'none';
      }
    }

    async function updateTestGroupList() {
      testGroups.innerHTML = '';
      
      const groupedByTest = {};
      quizItems.forEach(item => {
        if (!groupedByTest[item.testName]) {
          groupedByTest[item.testName] = [];
        }
        groupedByTest[item.testName].push(item);
      });

      if (Object.keys(groupedByTest).length === 0) {
        const noTestsMessage = document.createElement('div');
        noTestsMessage.textContent = 'Hozircha testlar mavjud emas';
        noTestsMessage.style.padding = '20px';
        noTestsMessage.style.textAlign = 'center';
        testGroups.appendChild(noTestsMessage);
        return;
      }

      Object.entries(groupedByTest).forEach(([testName, questions]) => {
        const testGroup = document.createElement('div');
        testGroup.className = 'test-group';
        
        const testHeader = document.createElement('div');
        testHeader.className = 'test-header';
        testHeader.innerHTML = `
          <span>${testName} (${questions.length} ta savol)</span>
          <div class="test-header-actions">
            <button class="edit-btn continue-test" data-test="${testName}">Davom ettirish</button>
            <button class="download-btn" data-test="${testName}">Yuklab olish</button>
            <button class="remove-btn" data-test="${testName}">O'chirish</button>
          </div>
        `;
        
        const testContent = document.createElement('div');
        testContent.className = 'test-content';
        
        const questionList = document.createElement('ol');
        questionList.className = 'question-list';
        
        questions.forEach(question => {
          const li = document.createElement('li');
          li.dataset.id = question.id;
          
          const questionText = document.createElement('div');
          questionText.textContent = question.question;
          questionText.style.fontWeight = 'bold';
          
          const optionsContainer = document.createElement('div');
          optionsContainer.style.marginTop = '10px';
          
          const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
          question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.style.margin = '5px 0';
            optionElement.innerHTML = `${letters[index]}. ${option} ${index === question.correctIndex ? '<strong>(‚úì)</strong>' : ''}`;
            optionsContainer.appendChild(optionElement);
          });
          
          const actions = document.createElement('div');
          actions.className = 'action-buttons';
          actions.style.marginTop = '10px';
          
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-btn';
          editBtn.textContent = 'Tahrirlash';
          editBtn.dataset.id = question.id;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'remove-btn';
          deleteBtn.textContent = 'O\'chirish';
          deleteBtn.dataset.id = question.id;
          
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          
          li.appendChild(questionText);
          li.appendChild(optionsContainer);
          li.appendChild(actions);
          questionList.appendChild(li);
        });
        
        testContent.appendChild(questionList);
        testGroup.appendChild(testHeader);
        testGroup.appendChild(testContent);
        testGroups.appendChild(testGroup);
        
        testHeader.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          
          testContent.classList.toggle('active');
        });
      });
      
      attachEventListeners();
    }

    function attachEventListeners() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        if (btn.classList.contains('continue-test')) {
          btn.addEventListener('click', function() {
            const testName = this.dataset.test;
            saveActiveTest(testName);
            tabs[0].click();
            showMessage(`"${testName}" testiga savollar qo'shishni davom ettirasiz`, 'success');
          });
        } else {
          btn.addEventListener('click', function() {
            const id = parseInt(this.dataset.id);
            const question = quizItems.find(item => item.id === id);
            if (!question) return;
            
            populateFormWithQuestion(question);
            tabs[0].click();
          });
        }
      });
      
      document.querySelectorAll('.remove-btn').forEach(btn => {
        if (btn.dataset.test) {
          btn.addEventListener('click', function() {
            const testName = this.dataset.test;
            if (confirm(`"${testName}" testini o'chirishni xohlaysizmi?`)) {
              deleteTestGroup(testName);
            }
          });
        } else {
          btn.addEventListener('click', function() {
            const id = parseInt(this.dataset.id);
            if (confirm('Savolni o\'chirishni xohlaysizmi?')) {
              deleteQuestion(id);
            }
          });
        }
      });
      
      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const testName = this.dataset.test;
          downloadTest(testName);
        });
      });
    }

    function populateFormWithQuestion(question) {
      quizForm.dataset.editId = question.id;
      
      testNameInput.value = question.testName;
      questionInput.value = question.question;
      
      adjustOptions(question.options.length);
      
      const optionInputs = document.querySelectorAll('.option input[type="text"]');
      question.options.forEach((option, index) => {
        optionInputs[index].value = option;
      });
      
      document.querySelectorAll('input[name="correctAnswer"]')[question.correctIndex].checked = true;
      
      submitBtn.textContent = 'Yangilash';
      updatePreview();
      
      quizForm.scrollIntoView({ behavior: 'smooth' });
    }

    function deleteQuestion(id) {
      const questionIndex = quizItems.findIndex(item => item.id === id);
      if (questionIndex === -1) return;
      
      const question = quizItems[questionIndex];
      
      const questionElement = document.querySelector(`li[data-id="${id}"]`);
      if (questionElement) {
        questionElement.classList.add('removing');
        setTimeout(() => {
          quizItems.splice(questionIndex, 1);
          saveQuizItems();
          
          if (question.testName === activeTest) {
            updatePreviewQuestions();
          }
          
          updateTestGroupList();
          showMessage('Savol muvaffaqiyatli o\'chirildi', 'success');
        }, 500);
      } else {
        quizItems.splice(questionIndex, 1);
        saveQuizItems();
        updateTestGroupList();
        if (question.testName === activeTest) {
          updatePreviewQuestions();
        }
        showMessage('Savol muvaffaqiyatli o\'chirildi', 'success');
      }
    }

    function deleteTestGroup(testName) {
      quizItems = quizItems.filter(item => item.testName !== testName);
      saveQuizItems();
      
      if (activeTest === testName) {
        finishTestBtn.click();
      }
      
      updateTestGroupList();
      showMessage(`"${testName}" testi muvaffaqiyatli o'chirildi`, 'success');
    }

    function downloadTest(testName) {
      const testQuestions = quizItems.filter(item => item.testName === testName);
      if (testQuestions.length === 0) return;
      
      let content = '';
      
      testQuestions.forEach((question) => {
        content += `${question.question}\n`;
        
        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        question.options.forEach((option, optIndex) => {
          content += `${letters[optIndex]}. ${option}\n`;
        });
        
        content += `ANSWER: ${letters[question.correctIndex]}\n\n`;
      });
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${testName}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showMessage(`"${testName}" testi muvaffaqiyatli yuklab olindi`, 'success');
    }

    function showMessage(message, type = 'info') {
      const messageElement = document.createElement('div');
      messageElement.className = `${type}-message`;
      messageElement.textContent = message;
      messageContainer.appendChild(messageElement);
      
      setTimeout(() => {
        messageElement.style.opacity = '0';
        setTimeout(() => {
          messageContainer.removeChild(messageElement);
        }, 300);
      }, 3000);
    }

    // Tezkor klavishlar
    document.addEventListener('keydown', (e) => {
      const isTyping = document.activeElement.tagName === 'INPUT' || 
                       document.activeElement.tagName === 'TEXTAREA';
      
      if (e.altKey && !e.shiftKey && !e.ctrlKey) {
        if (e.key === 'n' || e.key === 'N') {
          e.preventDefault();
          if (!activeTest) {
            testNameInput.focus();
          }
        }
        
        if (e.key === 'q' || e.key === 'Q') {
          e.preventDefault();
          questionInput.focus();
        }
        
        if (['1', '2', '3', '4'].includes(e.key)) {
          e.preventDefault();
          const optionIndex = parseInt(e.key) - 1;
          const options = optionsContainer.querySelectorAll('.option input[type="text"]');
          if (options[optionIndex]) {
            options[optionIndex].focus();
          }
        }
      }
      
      if (e.ctrlKey && e.altKey && !e.shiftKey) {
        if (['1', '2', '3', '4'].includes(e.key)) {
          e.preventDefault();
          const optionIndex = parseInt(e.key) - 1;
          const radios = optionsContainer.querySelectorAll('.option input[type="radio"]');
          if (radios[optionIndex]) {
            radios[optionIndex].checked = true;
            updatePreview();
            showShortcutFeedback(`Variant ${e.key} to'g'ri javob sifatida belgilandi`);
          }
        }
      }
      
      if (e.altKey && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        quizForm.dispatchEvent(new Event('submit'));
      }
    });
    
    function showShortcutFeedback(message) {
      const feedback = document.createElement('div');
      feedback.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(69, 96, 229, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        animation: fadeInOut 2s ease-out;
      `;
      feedback.textContent = message;
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.remove();
      }, 2000);
    }
  </script>
</body>
</html>
