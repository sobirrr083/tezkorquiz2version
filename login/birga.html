<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tezkor Quiz</title>
  <link rel="icon" href="tg.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.0/lottie.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <style>
    :root {
      --primary-color: #506eec;
      --secondary-color: #f5f7fb;
      --text-color: #333;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --background-color: #f5f7fb;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }

    .app-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .logo-icon {
      font-size: 28px;
    }

    .user-setup {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    .profile-section {
      text-align: center;
    }

    .profile-picture-container {
      position: relative;
      margin: 0 auto 15px;
      width: 100px;
      height: 100px;
    }

    .profile-picture {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
    }

    .edit-profile-icon {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: var(--primary-color);
      color: #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .profile-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .file-upload-container {
      margin-bottom: 15px;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background-color: var(--primary-color);
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      justify-content: center;
    }

    .file-upload-input {
      display: none;
    }

    .file-name-display {
      margin-top: 5px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 20px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: 14px;
      color: var(--text-color);
    }

    .profile-actions {
      display: flex;
      justify-content: center;
    }

    .action-button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s;
    }

    .action-button:hover {
      background-color: #3f5ac5;
    }

    .group-info {
      background-color: rgba(80, 110, 236, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }

    .group-info span {
      font-weight: bold;
      color: var(--primary-color);
    }

    .quiz-time-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 16px;
      color: var(--text-color);
    }

    .question-container {
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .question-text {
      font-weight: bold;
      font-size: 16px;
    }

    .view-answers-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 18px;
    }

    .users-indicator {
      background-color: var(--primary-color);
various: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .users-indicator.hidden {
      display: none;
    }

    .user-responses {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .mini-profile {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .mini-pic {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .mini-name {
      font-size: 12px;
      color: #666;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .option-item:hover {
      background-color: #f5f7fb;
    }

    .custom-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .checkmark {
      display: none;
      color: #fff;
      font-size: 12px;
    }

    .custom-checkbox.checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .custom-checkbox.checked .checkmark {
      display: block;
    }

    .option-text {
      flex: 1;
      font-size: 14px;
    }

    .option-stats {
      display: federale align-items: center;
      gap: 5px;
      font-size: 12px;
      color: #666;
    }

    .option-stats.hidden {
      display: none;
    }

    .votes-count {
      font-weight: bold;
    }

    .results-popup {
      display: none;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      box-shadow: var(--shadow);
    }

    .results-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .user-choice {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }

    .answer-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .correct-indicator {
      background-color: var(--correct-color);
    }

    .incorrect-indicator {
      background-color: var(--incorrect-color);
    }

    .option-item.correct {
      border-color: var(--correct-color);
      background-color: rgba(40, 167, 69, 0.1);
    }

    .option-item.incorrect {
      border-color: var(--incorrect-color);
      background-color: rgba(220, 53, 69, 0.1);
    }

    .option-item.correct-anim {
      animation: correctAnimation 0.5s;
    }

    .option-item.incorrect-anim {
      animation: incorrectAnimation 0.5s;
    }

    @keyframes correctAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes incorrectAnimation {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    .quiz-completion-section {
      text-align: center;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    #lottieContainer {
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }

    .celebration-title {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .stats-container {
      margin-bottom: 20px;
    }

    .stat-number {
      font-weight: bold;
      color: var(--primary-color);
    }

    .dual-progress {
      background-color: #ddd;
      border-radius: 5px;
      height: 20px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 12px;
      transition: width 0.5s ease-in-out;
    }

    .progress-correct {
      background-color: var(--correct-color);
    }

    .leaderboard-container {
      margin-top: 20px;
    }

    .leaderboard-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .rank-cell {
      width: 50px;
      text-align: center;
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rank-pic {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    .rank-name {
      font-size: 14px;
    }

    .score-cell,
    .percentage-cell {
      text-align: center;
      font-weight: bold;
    }

    .highlight-row {
      background-color: rgba(80, 110, 236, 0.1);
    }

    .toggle-users-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 50%;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .users-count-badge {
      background-color: #fff;
      color: var(--primary-color);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .online-users {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100%;
      background-color: #fff;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }

    .online-users.active {
      transform: translateX(0);
    }

    .online-users-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }

    .online-user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
    }

    .online-user-pic {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    .online-user-name {
      flex: 1;
      font-size: 14px;
    }

    .online-indicator {
      width: 10px;
      height: 10px;
      background-color: var(--correct-color);
      border-radius: 50%;
    }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 50%;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: none;
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .confetti {
      position: absolute;
      top: -10px;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>

<body>
  <button id="toggleUsersBtn" class="toggle-users-btn">
    <i class="fas fa-users"></i>
    <span class="users-count-badge">0</span>
  </button>
  
  <div id="onlineUsers" class="online-users">
    <div class="online-users-title">
      <span>Online Foydalanuvchilar</span>
      <i class="fas fa-times close-users-sidebar" style="cursor: pointer;"></i>
    </div>
    <div id="onlineUsersList"></div>
  </div>
  
  <div id="confettiContainer" class="confetti-container"></div>

  <div class="container">
    <div class="logo-container" id="appLogo">
      <div class="app-logo">
        <i class="fas fa-lightbulb logo-icon"></i>
        <span>Tezkor Quiz</span>
      </div>
    </div>

    <div id="userSetupSection" class="user-setup">
      <div class="profile-section">
        <div class="profile-picture-container">
          <img id="profilePicture" src="/api/placeholder/100/100" alt="User" class="profile-picture">
          <div class="edit-profile-icon" id="editProfilePic">
            <i class="fas fa-camera"></i>
          </div>
        </div>
        <input type="text" id="userName" class="profile-input" placeholder="Ismingizni kiriting" maxlength="20">
        
        <input type="file" id="profilePicInput" accept="image/*" class="file-upload-input">
        <p id="uploadStatus"></p>

        <div class="file-upload-container">
          <label for="questionFileInput" class="file-upload-label">
            <i class="fas fa-upload"></i> Savollar faylini tanlash
          </label>
          <input type="file" id="questionFileInput" accept=".txt" class="file-upload-input">
          <div id="fileNameDisplay" class="file-name-display">Fayl tanlanmadi</div>
        </div>

        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="waitForAllToggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">Barchani kutish (Kamida 2 foydalanuvchi)</span>
        </div>

        <div class="profile-actions">
          <button id="startQuizBtn" class="action-button">
            <i class="fas fa-play"></i> Quizni boshlash
          </button>
        </div>

        <div id="groupInfo" class="group-info" style="display: none;">
          Birgalikda boshlaganlar: <span id="groupUsers"></span>
        </div>
      </div>
    </div>

    <div id="quizSection" style="display: none;">
      <div class="quiz-time-display">
        <i class="fas fa-clock"></i>
        <span class="timer-container">Vaqt: <span id="quizTimer">00:00</span></span>
      </div>
      
      <div id="questionsContainer"></div>
      
      <button id="finishQuizBtn" class="action-button" style="width: 100%;">
        <i class="fas fa-check-circle"></i> Quizni yakunlash
      </button>
    </div>

    <div id="quizCompletionSection" style="display: none;">
      <div id="lottieContainer"></div>
      <h2 class="celebration-title">Tabriklaymiz!</h2>
      <div class="stats-container">
        <div class="row">
          <div class="col-md-6 mb-3">
            <p><i class="fas fa-check-circle" style="color: var(--correct-color);"></i> To'g'ri javoblar: <span id="correctAnswers" class="stat-number">0</span></p>
          </div>
          <div class="col-md-6 mb-3">
            <p><i class="fas fa-times-circle" style="color: var(--incorrect-color);"></i> Noto'g'ri javoblar: <span id="incorrectAnswers" class="stat-number">0</span></p>
          </div>
        </div>
        
        <div class="dual-progress">
          <div id="correctProgress" class="progress-bar progress-correct" style="width: 0%;">0%</div>
        </div>
        
        <p>Umumiy ball: <span id="totalScore" class="stat-number">0</span>/<span id="maxScore">0</span></p>
      </div>
      
      <div class="leaderboard-container">
        <div class="leaderboard-header">
          <i class="fas fa-trophy"></i> Peshqadamlar jadvali
        </div>
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th class="rank-cell">O'rin</th>
              <th>Foydalanuvchi</th>
              <th class="score-cell">Ball</th>
              <th class="percentage-cell">Foiz</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
      
      <button id="restartQuizBtn" class="action-button mt-4">
        <i class="fas fa-redo"></i> Qayta ishlash
      </button>
    </div>
  </div>

  <button id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </button>

  <script>
    // Firebase sozlamalari (o‘z loyihangiz ma’lumotlari bilan almashtiring)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Firebase’ni ishga tushirish
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    document.addEventListener("DOMContentLoaded", function() {
      // Variables
      let currentUser = {
        id: null,
        name: "",
        profilePic: "/api/placeholder/100/100",
        answers: {},
        score: 0,
        group: []
      };
      
      let allUsers = {};
      let questions = [];
      let quizStartTime = null;
      let quizTimer = null;
      let waitForAll = false;
      let readyUsers = new Set();

      // DOM elements
      const userNameInput = document.getElementById("userName");
      const profilePicture = document.getElementById("profilePicture");
      const profilePicInput = document.getElementById("profilePicInput");
      const uploadStatus = document.getElementById("uploadStatus");
      const startQuizBtn = document.getElementById("startQuizBtn");
      const questionsContainer = document.getElementById("questionsContainer");
      const finishQuizBtn = document.getElementById("finishQuizBtn");
      const quizTimerEl = document.getElementById("quizTimer");
      const userSetupSection = document.getElementById("userSetupSection");
      const quizSection = document.getElementById("quizSection");
      const quizCompletionSection = document.getElementById("quizCompletionSection");
      const correctAnswersEl = document.getElementById("correctAnswers");
      const incorrectAnswersEl = document.getElementById("incorrectAnswers");
      const correctProgressEl = document.getElementById("correctProgress");
      const totalScoreEl = document.getElementById("totalScore");
      const maxScoreEl = document.getElementById("maxScore");
      const leaderboardBody = document.getElementById("leaderboardBody");
      const restartQuizBtn = document.getElementById("restartQuizBtn");
      const backToTopBtn = document.getElementById("backToTop");
      const toggleUsersBtn = document.getElementById("toggleUsersBtn");
      const onlineUsers = document.getElementById("onlineUsers");
      const onlineUsersList = document.getElementById("onlineUsersList");
      const closeUsersSidebar = document.querySelector(".close-users-sidebar");
      const usersCountBadge = document.querySelector(".users-count-badge");
      const questionFileInput = document.getElementById("questionFileInput");
      const fileNameDisplay = document.getElementById("fileNameDisplay");
      const waitForAllToggle = document.getElementById("waitForAllToggle");
      const groupInfo = document.getElementById("groupInfo");
      const groupUsers = document.getElementById("groupUsers");

      // Sample questions data
      const sampleQuestions = [
        {
          id: 1,
          text: "O'zbekiston poytaxti qaysi shahar?",
          options: [
            { id: 1, text: "Toshkent" },
            { id: 2, text: "Samarqand" },
            { id: 3, text: "Buxoro" },
            { id: 4, text: "Namangan" }
          ],
          correctOptionId: 1
        }
      ];

      // Functions
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      
      function startTimer() {
        let seconds = 0;
        quizStartTime = new Date();
        quizTimer = setInterval(() => {
          seconds++;
          quizTimerEl.textContent = formatTime(seconds);
        }, 1000);
      }
      
      function stopTimer() {
        clearInterval(quizTimer);
      }

      function saveProfile() {
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        if (currentUser.id) {
          database.ref(`users/${currentUser.id}`).update({
            name: currentUser.name || "Anonim",
            profilePic: currentUser.profilePic,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      }

      function initializeApp() {
        auth.onAuthStateChanged(user => {
          if (user) {
            currentUser.id = user.uid;
            const savedUser = JSON.parse(localStorage.getItem("currentUser"));
            if (savedUser) {
              currentUser.name = savedUser.name;
              currentUser.profilePic = savedUser.profilePic;
              userNameInput.value = currentUser.name;
              profilePicture.src = currentUser.profilePic;
            }
            saveProfile();
            questions = sampleQuestions;
            setupEventListeners();
            updateOnlineUsersList();
            checkForSessionId();
          } else {
            auth.signInAnonymously().catch(error => {
              console.error("Anonim kirish xatosi:", error);
              alert("Autentifikatsiya muvaffaqiyatsiz. Iltimos, qayta urinib ko‘ring.");
            });
          }
        });
      }

      function setupEventListeners() {
        document.getElementById("editProfilePic").addEventListener("click", () => profilePicInput.click());
        profilePicInput.addEventListener("change", handleProfilePicUpload);
        startQuizBtn.addEventListener("click", startQuiz);
        finishQuizBtn.addEventListener("click", finishQuiz);
        restartQuizBtn.addEventListener("click", restartQuiz);
        window.addEventListener("scroll", toggleBackToTopButton);
        backToTopBtn.addEventListener("click", scrollToTop);
        toggleUsersBtn.addEventListener("click", toggleOnlineUsers);
        closeUsersSidebar.addEventListener("click", toggleOnlineUsers);
        userNameInput.addEventListener("input", updateUserName);
        questionFileInput.addEventListener("change", handleQuestionFileUpload);
        waitForAllToggle.addEventListener("change", function() {
          waitForAll = this.checked;
        });
      }

      function handleProfilePicUpload(event) {
        const file = event.target.files[0];
        if (file) {
          uploadStatus.textContent = "Rasm yuklanmoqda...";
          const reader = new FileReader();
          reader.onload = function(e) {
            profilePicture.src = e.target.result;
            currentUser.profilePic = e.target.result;
            uploadStatus.textContent = "Rasm yuklandi!";
            saveProfile();
            setTimeout(() => uploadStatus.textContent = "", 2000);
          };
          reader.readAsDataURL(file);
        }
      }

      function updateUserName() {
        currentUser.name = userNameInput.value.trim();
        saveProfile();
      }

      function handleQuestionFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = e.target.result;
            parseQuestionsFromText(content);
          };
          reader.readAsText(file);
        }
      }

      function parseQuestionsFromText(content) {
        const lines = content.split('\n');
        questions = [];
        let currentQuestion = null;

        lines.forEach(line => {
          line = line.trim();
          if (line && !line.startsWith('ANSWER:')) {
            if (!line.startsWith('A.') && !line.startsWith('B.') && !line.startsWith('C.') && !line.startsWith('D.')) {
              if (currentQuestion) questions.push(currentQuestion);
              currentQuestion = {
                id: questions.length + 1,
                text: line,
                options: [],
                correctOptionId: null
              };
            } else {
              const optionId = currentQuestion.options.length + 1;
              const optionText = line.substring(2).trim();
              currentQuestion.options.push({ id: optionId, text: optionText });
            }
          } else if (line.startsWith('ANSWER:')) {
            const answer = line.split('ANSWER:')[1].trim();
            const optionMap = { 'A': 1, 'B': 2, 'C': 3, 'D': 4 };
            currentQuestion.correctOptionId = optionMap[answer];
          }
        });

        if (currentQuestion) questions.push(currentQuestion);

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) {
          database.ref(`quizSessions/${sessionId}/questions`).set(questions);
        }

        alert("Savollar muvaffaqiyatli yuklandi!");
      }

      function startQuiz() {
        if (!currentUser.name) {
          alert("Iltimos, ismingizni kiriting!");
          return;
        }

        if (waitForAll) {
          startQuizBtn.innerHTML = `<span class="loading-spinner"></span> ${readyUsers.size} foydalanuvchi tayyor`;
          startQuizBtn.disabled = true;

          const sessionId = database.ref("quizSessions").push().key;
          const sessionData = {
            creator: currentUser.id,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: "waiting",
            participants: {
              [currentUser.id]: {
                name: currentUser.name,
                profilePic: currentUser.profilePic,
                ready: true
              }
            },
            questions: questions
          };

          database.ref(`quizSessions/${sessionId}`).set(sessionData).then(() => {
            readyUsers.add(currentUser.id);
            allUsers[currentUser.id] = currentUser;
            const shareLink = `${window.location.origin}${window.location.pathname}?sessionId=${sessionId}`;
            groupInfo.style.display = "block";
            groupUsers.innerHTML = `Ushbu havolani ulashing: <a href="${shareLink}" target="_blank">${shareLink}</a>`;
            listenForParticipants(sessionId);
          }).catch(error => {
            console.error("Sessiya yaratish xatosi:", error);
            alert("Sessiya yaratishda xato yuz berdi!");
          });
        } else {
          proceedToQuiz();
        }
      }

      function checkForSessionId() {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) {
          database.ref(`quizSessions/${sessionId}`).once("value").then(snapshot => {
            if (snapshot.exists()) {
              const session = snapshot.val();
              questions = session.questions || sampleQuestions;
              database.ref(`quizSessions/${sessionId}/participants/${currentUser.id}`).set({
                name: currentUser.name,
                profilePic: currentUser.profilePic,
                ready: false
              });
              readyUsers.add(currentUser.id);
              allUsers[currentUser.id] = currentUser;
              listenForParticipants(sessionId);
            } else {
              alert("Noto‘g‘ri sessiya ID!");
            }
          }).catch(error => {
            console.error("Sessiyani tekshirish xatosi:", error);
            alert("Sessiyani tekshirishda xato yuz berdi!");
          });
        }
      }

      function listenForParticipants(sessionId) {
        database.ref(`quizSessions/${sessionId}/participants`).on("value", snapshot => {
          const participants = snapshot.val() || {};
          allUsers = {};
          readyUsers.clear();
          Object.entries(participants).forEach(([uid, participant]) => {
            allUsers[uid] = {
              id: uid,
              name: participant.name,
              profilePic: participant.profilePic,
              answers: participant.answers || {},
              score: participant.score || 0
            };
            if (participant.ready) readyUsers.add(uid);
          });
          updateOnlineUsersList();
          startQuizBtn.innerHTML = `<span class="loading-spinner"></span> ${readyUsers.size} foydalanuvchi tayyor`;
          const participantNames = Object.values(participants).map(p => p.name).join(", ");
          groupUsers.textContent = participantNames || "Hozircha ishtirokchilar yo‘q";
          checkAllUsersReady(sessionId);
        }, error => {
          console.error("Ishtirokchilarni kuzatish xatosi:", error);
        });

        startQuizBtn.onclick = () => {
          database.ref(`quizSessions/${sessionId}/participants/${currentUser.id}/ready`).set(true);
        };
      }

      function checkAllUsersReady(sessionId) {
        if (readyUsers.size >= 2 && (readyUsers.size === Object.keys(allUsers).length || !waitForAll)) {
          database.ref(`quizSessions/${sessionId}`).update({ status: "started" });
          currentUser.group = Object.values(allUsers).map(u => u.name);
          groupInfo.style.display = "block";
          groupUsers.textContent = currentUser.group.join(", ");
          proceedToQuiz();
        }
      }

      function proceedToQuiz() {
        userSetupSection.style.display = "none";
        quizSection.style.display = "block";
        renderQuestions();
        startTimer();
        updateOnlineUsersList();
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) listenForAnswers(sessionId);
      }

      function listenForAnswers(sessionId) {
        database.ref(`quizSessions/${sessionId}/participants`).on("value", snapshot => {
          const participants = snapshot.val() || {};
          Object.entries(participants).forEach(([uid, participant]) => {
            allUsers[uid].answers = participant.answers || {};
          });
          questions.forEach(question => {
            updateUserResponses(question.id);
            updateOptionStats(question.id);
            updateResultsList(question.id);
          });
        }, error => {
          console.error("Javoblarni kuzatish xatosi:", error);
        });
      }

      function renderQuestions() {
        questionsContainer.innerHTML = "";
        
        questions.forEach(question => {
          const questionElement = document.createElement("div");
          questionElement.className = "question-container";
          questionElement.dataset.questionId = question.id;
          
          const questionHeader = document.createElement("div");
          questionHeader.className = "question-header";
          
          const questionText = document.createElement("div");
          questionText.className = "question-text";
          questionText.textContent = `${question.id}. ${question.text}`;
          
          const viewAnswersBtn = document.createElement("button");
          viewAnswersBtn.className = "view-answers-btn";
          viewAnswersBtn.innerHTML = '<i class="fas fa-users"></i>';
          viewAnswersBtn.addEventListener("click", () => toggleResultsPopup(question.id));
          
          questionHeader.appendChild(questionText);
          questionHeader.appendChild(viewAnswersBtn);
          
          const usersIndicator = document.createElement("div");
          usersIndicator.className = "users-indicator hidden";
          usersIndicator.innerHTML = "0";
          usersIndicator.addEventListener("click", () => toggleResultsPopup(question.id));
          
          const userResponses = document.createElement("div");
          userResponses.className = "user-responses";
          userResponses.id = `userResponses_${question.id}`;
          
          const optionsContainer = document.createElement("div");
          optionsContainer.className = "options-container";
          
          question.options.forEach(option => {
            const optionItem = document.createElement("div");
            optionItem.className = "option-item";
            optionItem.dataset.optionId = option.id;
            optionItem.addEventListener("click", () => selectOption(question.id, option.id));
            
            const customCheckbox = document.createElement("div");
            customCheckbox.className = "custom-checkbox";
            
            const checkmark = document.createElement("span");
            checkmark.className = "checkmark";
            checkmark.innerHTML = '<i class="fas fa-check"></i>';
            customCheckbox.appendChild(checkmark);
            
            const optionText = document.createElement("div");
            optionText.className = "option-text";
            optionText.textContent = option.text;
            
            const optionStats = document.createElement("div");
            optionStats.className = "option-stats hidden";
            optionStats.innerHTML = '<span class="votes-count">0</span> <span class="votes-percentage">(0%)</span>';
            
            optionItem.appendChild(customCheckbox);
            optionItem.appendChild(optionText);
            optionItem.appendChild(optionStats);
            optionsContainer.appendChild(optionItem);
          });
          
          const resultsPopup = document.createElement("div");
          resultsPopup.className = "results-popup";
          resultsPopup.id = `resultsPopup_${question.id}`;
          
          const resultsTitle = document.createElement("div");
          resultsTitle.className = "results-title";
          resultsTitle.textContent = "Foydalanuvchilar javoblari";
          
          const resultsList = document.createElement("div");
          resultsList.className = "results-list";
          resultsList.id = `resultsList_${question.id}`;
          
          resultsPopup.appendChild(resultsTitle);
          resultsPopup.appendChild(resultsList);
          
          questionElement.appendChild(questionHeader);
          questionElement.appendChild(usersIndicator);
          questionElement.appendChild(userResponses);
          questionElement.appendChild(optionsContainer);
          questionElement.appendChild(resultsPopup);
          
          questionsContainer.appendChild(questionElement);
        });
      }

      function selectOption(questionId, optionId) {
        const questionContainer = document.querySelector(`.question-container[data-question-id="${questionId}"]`);
        const optionItems = questionContainer.querySelectorAll('.option-item');
        const selectedQuestion = questions.find(q => q.id === parseInt(questionId));
        
        optionItems.forEach(item => {
          const checkbox = item.querySelector('.custom-checkbox');
          checkbox.classList.remove('checked');
        });
        
        const selectedOption = questionContainer.querySelector(`.option-item[data-option-id="${optionId}"]`);
        const checkbox = selectedOption.querySelector('.custom-checkbox');
        checkbox.classList.add('checked');
        
        currentUser.answers[questionId] = parseInt(optionId);
        allUsers[currentUser.id] = currentUser;
        
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) {
          database.ref(`quizSessions/${sessionId}/participants/${currentUser.id}/answers/${questionId}`).set(parseInt(optionId));
        }
        
        updateUserResponses(questionId);
        
        const isCorrect = selectedQuestion.correctOptionId === parseInt(optionId);
        if (isCorrect) {
          selectedOption.classList.add('correct', 'correct-anim');
        } else {
          selectedOption.classList.add('incorrect', 'incorrect-anim');
          const correctOption = questionContainer.querySelector(`.option-item[data-option-id="${selectedQuestion.correctOptionId}"]`);
          correctOption.classList.add('correct');
        }
        
        setTimeout(() => {
          selectedOption.classList.remove('correct-anim', 'incorrect-anim');
        }, 800);
        
        updateOptionStats(questionId);
      }

      function updateUserResponses(questionId) {
        const userResponsesContainer = document.getElementById(`userResponses_${questionId}`);
        userResponsesContainer.innerHTML = "";
        
        const userAnswer = currentUser.answers[questionId];
        if (userAnswer) {
          const miniProfile = document.createElement("div");
          miniProfile.className = "mini-profile";
          
          const miniPic = document.createElement("img");
          miniPic.className = "mini-pic";
          miniPic.src = currentUser.profilePic;
          miniPic.alt = currentUser.name;
          
          const miniName = document.createElement("div");
          miniName.className = "mini-name";
          miniName.textContent = currentUser.name;
          
          miniProfile.appendChild(miniPic);
          miniProfile.appendChild(miniName);
          userResponsesContainer.appendChild(miniProfile);
        }
        
        Object.values(allUsers).forEach(user => {
          if (user.id !== currentUser.id && user.answers[questionId]) {
            const miniProfile = document.createElement("div");
            miniProfile.className = "mini-profile";
            
            const miniPic = document.createElement("img");
            miniPic.className = "mini-pic";
            miniPic.src = user.profilePic;
            miniPic.alt = user.name;
            
            const miniName = document.createElement("div");
            miniName.className = "mini-name";
            miniName.textContent = user.name;
            
            miniProfile.appendChild(miniPic);
            miniProfile.appendChild(miniName);
            userResponsesContainer.appendChild(miniProfile);
          }
        });
      }

      function updateResultsList(questionId) {
        const resultsList = document.getElementById(`resultsList_${questionId}`);
        resultsList.innerHTML = "";
        
        const selectedQuestion = questions.find(q => q.id === parseInt(questionId));
        
        const answeredUsers = Object.values(allUsers).filter(user => user.answers[questionId]);
        
        answeredUsers.forEach(user => {
          const userChoice = document.createElement("div");
          userChoice.className = "user-choice";
          
          const answerIndicator = document.createElement("span");
          answerIndicator.className = "answer-indicator";
          answerIndicator.classList.add(
            user.answers[questionId] === selectedQuestion.correctOptionId ? "correct-indicator" : "incorrect-indicator"
          );
          
          const miniPic = document.createElement("img");
          miniPic.className = "mini-pic";
          miniPic.src = user.profilePic;
          miniPic.alt = user.name;
          
          const miniName = document.createElement("span");
          miniName.style.marginLeft = "5px";
          miniName.textContent = user.name;
          
          const chosenOption = document.createElement("span");
          chosenOption.style.marginLeft = "auto";
          chosenOption.style.fontWeight = "bold";
          
          const selectedOption = selectedQuestion.options.find(opt => opt.id === user.answers[questionId]);
          chosenOption.textContent = selectedOption ? selectedOption.text : "";
          
          userChoice.appendChild(answerIndicator);
          userChoice.appendChild(miniPic);
          userChoice.appendChild(miniName);
          userChoice.appendChild(chosenOption);
          
          resultsList.appendChild(userChoice);
        });
      }

      function toggleResultsPopup(questionId) {
        const resultsPopup = document.getElementById(`resultsPopup_${questionId}`);
        
        document.querySelectorAll('.results-popup').forEach(popup => {
          if (popup.id !== `resultsPopup_${questionId}`) popup.style.display = "none";
        });
        
        updateResultsList(questionId);
        resultsPopup.style.display = resultsPopup.style.display === "block" ? "none" : "block";
      }

      function updateOptionStats(questionId) {
        const questionContainer = document.querySelector(`.question-container[data-question-id="${questionId}"]`);
        const optionItems = questionContainer.querySelectorAll('.option-item');
        const usersIndicator = questionContainer.querySelector('.users-indicator');
        
        const optionCounts = {};
        let totalResponses = 0;
        
        optionItems.forEach(item => {
          const optionId = parseInt(item.dataset.optionId);
          optionCounts[optionId] = 0;
        });
        
        Object.values(allUsers).forEach(user => {
          if (user.answers[questionId]) {
            const optionId = user.answers[questionId];
            optionCounts[optionId]++;
            totalResponses++;
          }
        });
        
        optionItems.forEach(item => {
          const optionId = parseInt(item.dataset.optionId);
          const optionStats = item.querySelector('.option-stats');
          const votesCount = optionStats.querySelector('.votes-count');
          const votesPercentage = optionStats.querySelector('.votes-percentage');
          
          const count = optionCounts[optionId];
          const percentage = totalResponses > 0 ? Math.round((count / totalResponses) * 100) : 0;
          
          votesCount.textContent = count;
          votesPercentage.textContent = `(${percentage}%)`;
          
          if (count > 0) optionStats.classList.remove('hidden');
        });
        
        if (totalResponses > 0) {
          usersIndicator.textContent = totalResponses;
          usersIndicator.classList.remove('hidden');
        }
      }

      function finishQuiz() {
        stopTimer();
        calculateScore();
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) {
          database.ref(`quizSessions/${sessionId}/participants/${currentUser.id}/score`).set(currentUser.score);
        }
        quizSection.style.display = "none";
        quizCompletionSection.style.display = "block";
        displayResults();
        updateLeaderboard();
        playCompletionAnimation();
        if (isUserInTopThree()) createConfetti();
      }

      function calculateScore() {
        let correctCount = 0;
        questions.forEach(question => {
          const userAnswer = currentUser.answers[question.id];
          if (userAnswer && userAnswer === question.correctOptionId) correctCount++;
        });
        currentUser.score = correctCount;
        allUsers[currentUser.id] = currentUser;
      }

      function displayResults() {
        const correctCount = currentUser.score;
        const totalQuestions = questions.length;
        const incorrectCount = totalQuestions - correctCount;
        const percentage = Math.round((correctCount / totalQuestions) * 100);
        
        correctAnswersEl.textContent = correctCount;
        incorrectAnswersEl.textContent = incorrectCount;
        correctProgressEl.style.width = `${percentage}%`;
        correctProgressEl.textContent = `${percentage}%`;
        totalScoreEl.textContent = correctCount;
        maxScoreEl.textContent = totalQuestions;
      }

      function updateLeaderboard() {
        leaderboardBody.innerHTML = "";
        const sortedUsers = Object.values(allUsers).sort((a, b) => b.score - a.score);
        
        sortedUsers.forEach((user, index) => {
          const rank = index + 1;
          const percentage = Math.round((user.score / questions.length) * 100);
          
          const row = document.createElement("tr");
          if (user.id === currentUser.id) row.className = "highlight-row";
          
          const rankCell = document.createElement("td");
          rankCell.className = "rank-cell";
          rankCell.textContent = rank <= 3 ? rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉' : rank;
          
          const userCell = document.createElement("td");
          userCell.className = "user-cell";
          
          const userImg = document.createElement("img");
          userImg.className = "rank-pic";
          userImg.src = user.profilePic;
          userImg.alt = user.name;
          
          const userName = document.createElement("span");
          userName.className = "rank-name";
          userName.textContent = user.name;
          
          userCell.appendChild(userImg);
          userCell.appendChild(userName);
          
          const scoreCell = document.createElement("td");
          scoreCell.className = "score-cell";
          scoreCell.textContent = user.score;
          
          const percentageCell = document.createElement("td");
          percentageCell.className = "percentage-cell";
          percentageCell.textContent = `${percentage}%`;
          
          row.appendChild(rankCell);
          row.appendChild(userCell);
          row.appendChild(scoreCell);
          row.appendChild(percentageCell);
          
          leaderboardBody.appendChild(row);
        });
      }

      function playCompletionAnimation() {
        const lottieContainer = document.getElementById("lottieContainer");
        const percentage = Math.round((currentUser.score / questions.length) * 100);
        let animationPath = percentage >= 80 ? "https://assets6.lottiefiles.com/packages/lf20_touohxv0.json" :
                          percentage >= 50 ? "https://assets7.lottiefiles.com/private_files/lf30_poez9ped.json" :
                          "https://assets9.lottiefiles.com/private_files/lf30_ulp9xqqw.json";
        
        lottie.loadAnimation({
          container: lottieContainer,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: animationPath
        });
      }

      function isUserInTopThree() {
        const sortedUsers = Object.values(allUsers).sort((a, b) => b.score - a.score);
        return sortedUsers.findIndex(user => user.id === currentUser.id) < 3;
      }

      function createConfetti() {
        const confettiContainer = document.getElementById("confettiContainer");
        const colors = ['#ffd700', '#ff0000', '#00ff00', '#0000ff', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.width = `${Math.random() * 10 + 5}px`;
          confetti.style.height = `${Math.random() * 10 + 5}px`;
          confetti.style.opacity = Math.random();
          confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
          confetti.style.animationDelay = `${Math.random() * 2}s`;
          
          confettiContainer.appendChild(confetti);
        }
        
        setTimeout(() => confettiContainer.innerHTML = '', 5000);
      }

      function restartQuiz() {
        currentUser.answers = {};
        currentUser.score = 0;
        quizCompletionSection.style.display = "none";
        userSetupSection.style.display = "block";
        document.getElementById("lottieContainer").innerHTML = "";
        startQuizBtn.innerHTML = `<i class="fas fa-play"></i> Quizni boshlash`;
        startQuizBtn.disabled = false;
        readyUsers.clear();
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        if (sessionId) {
          database.ref(`quizSessions/${sessionId}/participants/${currentUser.id}`).remove();
        }
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      function toggleBackToTopButton() {
        backToTopBtn.style.display = window.pageYOffset > 300 ? "block" : "none";
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function toggleOnlineUsers() {
        onlineUsers.classList.toggle("active");
      }

      function updateOnlineUsersList() {
        onlineUsersList.innerHTML = "";
        const onlineUserCount = Object.keys(allUsers).length;
        usersCountBadge.textContent = onlineUserCount;
        
        Object.values(allUsers).forEach(user => {
          const userItem = document.createElement("div");
          userItem.className = "online-user-item";
          
          const userPic = document.createElement("img");
          userPic.className = "online-user-pic";
          userPic.src = user.profilePic;
          userPic.alt = user.name;
          
          const userName = document.createElement("div");
          userName.className = "online-user-name";
          userName.textContent = user.name;
          
          const onlineIndicator = document.createElement("div");
          onlineIndicator.className = "online-indicator";
          
          userItem.appendChild(userPic);
          userItem.appendChild(userName);
          userItem.appendChild(onlineIndicator);
          
          onlineUsersList.appendChild(userItem);
        });
      }

      initializeApp();
    });
  </script>
</body>
</html>