<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilim Quiz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        .quiz-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
            margin: 1rem;
            max-width: 900px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .quiz-header {
            display: none; /* Sarlavha olib tashlandi */
        }
        .file-upload-area {
            border: 2px dashed #d0d0d0;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            margin: 2rem 0;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload-area:hover {
            background: #f5f5f5;
            border-color: #a0a0a0;
        }
        .file-upload-area.dragover {
            background: #efefef;
            border-color: #909090;
            transform: scale(1.01);
        }
        .progress-container {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .progress {
            flex: 1;
            height: 8px;
            border-radius: 10px;
            background: #e8e8e8;
            overflow: hidden;
            min-width: 200px;
        }
        .progress-bar {
            background: #2c2c2c;
            transition: width 0.6s ease;
            border-radius: 10px;
        }
        .progress-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #6c757d;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        .timer {
            background: #2c2c2c;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .timer.warning {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        .question-container {
            display: none;
            animation: scaleIn 0.3s ease;
        }
        .question-container.active {
            display: block;
        }
        .question-card {
            background: #fafafa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e8e8e8;
        }
        /* Savol raqami olib tashlandi */
        .question-text {
            font-size: 1.4rem;
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        .answers {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .answer-option {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 1.2rem 1.5rem;
            cursor: pointer;
            transition: all 0.25s ease;
            color: #2c2c2c;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .answer-option:hover {
            border-color: #2c2c2c;
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .answer-option.selected {
            background: #2c2c2c;
            color: white;
            border-color: #2c2c2c;
            box-shadow: 0 4px 16px rgba(44,44,44,0.3);
        }
        .answer-option.selected:hover {
            background: #1a1a1a;
            border-color: #1a1a1a;
        }
        .control-buttons {
            display: none;
        }
        .btn-custom {
            padding: 12px 32px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.95rem;
        }
        .btn-primary-custom {
            background: #2c2c2c;
            color: white;
        }
        .btn-primary-custom:hover {
            background: #1a1a1a !important;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary-custom {
            background: #e8e8e8;
            color: #2c2c2c;
            margin-right: 1rem;
        }
        .btn-secondary-custom:hover {
            background: #d0d0d0;
            transform: translateY(-2px);
        }
        .start-screen, .result-screen {
            text-align: center;
            padding: 2rem 0;
        }
        .start-screen h1 {
            color: #2c2c2c;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .start-screen p {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 2rem;
        }
        .quiz-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            padding: 1.5rem 2rem;
            background: #fafafa;
            border-radius: 12px;
            border: 1px solid #e8e8e8;
            min-width: 180px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUpStat 0.6s ease forwards;
        }
        .stat-item:nth-child(1) { animation-delay: 0.2s; }
        .stat-item:nth-child(2) { animation-delay: 0.4s; }
        .stat-item:nth-child(3) { animation-delay: 0.6s; }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 600;
            color: #2c2c2c;
        }
        .stat-number.correct { color: #10b981; }
        .stat-number.wrong { color: #ef4444; }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }
        .result-badge {
            display: inline-block;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1rem 0;
            opacity: 0;
            transform: scale(0.9);
            animation: scaleInBadge 0.5s ease 0.1s forwards;
        }
        .result-excellent {
            background: #10b981;
            color: white;
        }
        .result-good {
            background: #2c2c2c;
            color: white;
        }
        .result-average {
            background: #f59e0b;
            color: white;
        }
        .result-poor {
            background: #ef4444;
            color: white;
        }
        .loaded-questions-info {
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }
        .loaded-questions-info h5 {
            color: #2c2c2c;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .file-input {
            display: none;
        }
        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes scaleInBadge {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeInUpStat {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }
        #reviewSummary {
            margin-top: 2rem;
            text-align: center;
            font-size: 1.2rem;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUpStat 0.6s ease 0.8s forwards;
        }
        #reviewSummary p {
            margin: 1rem 0;
            font-weight: 500;
        }
        #reviewList {
            margin-top: 2rem;
            text-align: left;
            display: none;
        }
        .review-question {
            background: #fafafa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e8e8e8;
        }
        .review-question-text {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2c2c2c;
        }
        .review-options {
            margin-left: 1rem;
        }
        .review-option {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: white;
        }
        .review-correct {
            color: #10b981;
            font-weight: 600;
        }
        .review-incorrect {
            color: #ef4444;
            font-weight: 600;
        }
        .format-info {
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        .format-info h6 {
            color: #2c2c2c;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .format-info p {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.8;
            margin: 0;
        }
        /* Toast/Popup styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .custom-toast {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #10b981;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .custom-toast.error {
            border-left-color: #ef4444;
        }
        .toast-icon {
            font-size: 1.5rem;
        }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            color: #6c757d;
            font-size: 0.9rem;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        @media (max-width: 768px) {
            .quiz-container {
                margin: 0.5rem;
                padding: 1.5rem;
                border-radius: 12px;
            }
            .question-text {
                font-size: 1.2rem;
            }
            .answer-option {
                padding: 1.4rem 1.2rem;
                font-size: 1rem;
            }
            .quiz-stats {
                gap: 1rem;
            }
            .stat-item {
                padding: 1.2rem;
                min-width: 140px;
            }
            .stat-number {
                font-size: 2rem;
            }
            .progress-container {
                flex-direction: column;
                align-items: stretch;
            }
            .progress-info {
                justify-content: center;
            }
            .toast-container {
                right: 10px;
                left: 10px;
            }
            .custom-toast {
                min-width: auto;
            }
        }
        @media (max-width: 480px) {
            .question-text {
                font-size: 1.1rem;
            }
            .answer-option {
                padding: 1.3rem 1rem;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="quiz-container">
        <!-- Boshlash ekrani -->
        <div id="startScreen" class="start-screen">
            <h1><i class="fas fa-brain"></i> Bilim Quiz</h1>
            <p>Test savollarini yuklang va bilimlaringizni sinab ko'ring</p>
            
            <div class="file-upload-area" id="fileUploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4 style="color: #2c2c2c; font-weight: 600;">Test faylini yuklang</h4>
                <p style="color: #6c757d;">Fayl formatiga mos ravishda test savollarini yuklang</p>
                <input type="file" id="fileInput" class="file-input" accept=".txt">
                <button class="btn btn-custom btn-primary-custom mt-2">
                    <i class="fas fa-folder-open"></i> Fayl Tanlash
                </button>
            </div>
            
            <div id="loadedQuestionsInfo" class="loaded-questions-info" style="display: none;">
                <h5><i class="fas fa-check-circle"></i> Test Yuklandi</h5>
                <div class="quiz-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="loadedQuestionsCount">0</div>
                        <div class="stat-label">Savollar</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="calculatedTime">0</div>
                        <div class="stat-label">Daqiqa</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">4</div>
                        <div class="stat-label">Variant</div>
                    </div>
                </div>
                <button id="startBtn" class="btn btn-custom btn-primary-custom">
                    <i class="fas fa-play"></i> Testni Boshlash
                </button>
            </div>
            
            <div class="format-info">
                <h6><i class="fas fa-info-circle"></i> Fayl Formati:</h6>
                <p>
                    Savol matni?<br>
                    A. Variant 1<br>
                    B. Variant 2<br>
                    C. Variant 3<br>
                    D. Variant 4<br>
                    ANSWER: A
                </p>
            </div>
        </div>
        
        <!-- Quiz ekrani -->
        <div id="quizScreen" style="display: none;">
            <div class="quiz-header">
                <h2 class="quiz-title">Bilim Quiz</h2>
                <div class="timer" id="timer">
                    <i class="fas fa-clock"></i> <span id="timeLeft">0</span>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span><span id="currentQuestion">1</span> / <span id="totalQuestions">0</span> savol</span>
                    <div class="timer" id="timerClone">
                        <i class="fas fa-clock"></i> <span id="timeLeftClone">0</span>
                    </div>
                </div>
            </div>
            <div id="questionContainer"></div>
        </div>
        
        <!-- Natija ekrani -->
        <div id="resultScreen" class="result-screen" style="display: none;">
            <h2 class="quiz-title d-none d-md-block">Test Yakunlandi</h2>
            <div id="resultBadge" class="result-badge"></div>
           
            <div class="quiz-stats">
                <div class="stat-item">
                    <div class="stat-number correct" id="correctAnswers">0</div>
                    <div class="stat-label">To'g'ri javoblar</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number wrong" id="wrongAnswers">0</div>
                    <div class="stat-label">Noto'g'ri javoblar</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="finalScore">0%</div>
                    <div class="stat-label">Ball</div>
                </div>
            </div>
            <div id="reviewSummary">
                <h4 style="color: #2c2c2c; font-weight: 600; margin-bottom: 1rem;">Javoblar soni:</h4>
                <p>To'g'ri: <strong class="correct" id="summaryCorrect">0</strong> | Noto'g'ri: <strong class="wrong" id="summaryWrong">0</strong></p>
                <button id="showMoreBtn" class="btn btn-custom btn-secondary-custom mt-3">
                    Ko'proq ko'rsatish <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div id="reviewList"></div>
            <div class="mt-4">
                <button id="restartBtn" class="btn btn-custom btn-primary-custom me-3">
                    <i class="fas fa-redo"></i> Qayta Boshlash
                </button>
                <button id="newTestBtn" class="btn btn-custom btn-secondary-custom">
                    <i class="fas fa-file-upload"></i> Yangi Test
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        class QuizApp {
            constructor() {
                this.questions = [];
                this.originalQuestions = [];
                this.currentQuestion = 0;
                this.score = 0;
                this.timeLeft = 0;
                this.totalTime = 0;
                this.timer = null;
                this.userAnswers = [];
                this.shuffledIndices = [];
                this.questionOrder = [];
                
                this.initElements();
                this.bindEvents();
            }
            
            initElements() {
                this.startScreen = document.getElementById('startScreen');
                this.quizScreen = document.getElementById('quizScreen');
                this.resultScreen = document.getElementById('resultScreen');
                this.questionContainer = document.getElementById('questionContainer');
                this.progressBar = document.getElementById('progressBar');
                this.currentQuestionEl = document.getElementById('currentQuestion');
                this.totalQuestionsEl = document.getElementById('totalQuestions');
                this.timerEl = document.getElementById('timeLeft');
                this.timerCloneEl = document.getElementById('timeLeftClone');
                this.fileInput = document.getElementById('fileInput');
                this.fileUploadArea = document.getElementById('fileUploadArea');
                this.loadedQuestionsInfo = document.getElementById('loadedQuestionsInfo');
                this.startBtn = document.getElementById('startBtn');
                this.showMoreBtn = document.getElementById('showMoreBtn');
            }
            
            bindEvents() {
                this.fileUploadArea.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.fileUploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.fileUploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.fileUploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
                this.startBtn.addEventListener('click', () => this.startQuiz());
                document.getElementById('restartBtn').addEventListener('click', () => this.restartQuiz());
                document.getElementById('newTestBtn').addEventListener('click', () => this.newTest());
                this.showMoreBtn.addEventListener('click', () => this.toggleFullReview());
            }
            
            showToast(title, message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `custom-toast ${type === 'error' ? 'error' : ''}`;
                
                const icon = type === 'success' ? '‚úì' : '‚úï';
                const iconColor = type === 'success' ? '#10b981' : '#ef4444';
                
                toast.innerHTML = `
                    <div class="toast-icon" style="color: ${iconColor}">${icon}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            handleDragOver(e) {
                e.preventDefault();
                this.fileUploadArea.classList.add('dragover');
            }
            
            handleDragLeave(e) {
                e.preventDefault();
                this.fileUploadArea.classList.remove('dragover');
            }
            
            handleFileDrop(e) {
                e.preventDefault();
                this.fileUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.processFile(files[0]);
                }
            }
            
            handleFileUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }
            
            processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        this.parseQuestions(content);
                    } catch (error) {
                        this.showToast('Xatolik', 'Fayl o\'qishda xatolik yuz berdi', 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            parseQuestions(content) {
                const lines = content.trim().split('\n').map(l => l.trim()).filter(l => l !== '');
                const questions = [];
                const originalQuestions = [];
                let currentQuestion = null;
                let options = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.startsWith('ANSWER:')) {
                        const answerLetter = line.split(':')[1].trim().toUpperCase();
                        const answerIndex = answerLetter.charCodeAt(0) - 65;
                        
                        if (currentQuestion && options.length === 4 && answerIndex >= 0 && answerIndex < 4) {
                            originalQuestions.push({
                                question: currentQuestion,
                                options: [...options],
                                correct: answerIndex
                            });
                            questions.push({
                                question: currentQuestion,
                                options: [...options],
                                correct: answerIndex
                            });
                        }
                        currentQuestion = null;
                        options = [];
                    } else if (line.match(/^[A-D]\./i)) {
                        const optionText = line.substring(2).trim();
                        options.push(optionText);
                    } else {
                        if (currentQuestion) {
                            currentQuestion += ' ' + line;
                        } else {
                            currentQuestion = line;
                        }
                    }
                }
                
                if (questions.length > 0) {
                    this.originalQuestions = originalQuestions;
                    this.questionOrder = Array.from({length: questions.length}, (_, i) => i);
                    this.questionOrder = this.shuffleArray(this.questionOrder);
                    
                    this.shuffledIndices = [];
                    this.questions = questions.map((q, idx) => {
                        const indices = [0,1,2,3];
                        const shuffled = this.shuffleArray([...indices]);
                        this.shuffledIndices[idx] = shuffled;
                        const shuffledOpts = shuffled.map(i => q.options[i]);
                        const newCorrect = shuffled.indexOf(q.correct);
                        return {
                            question: q.question,
                            options: shuffledOpts,
                            correct: newCorrect
                        };
                    });
                    
                    this.calculateTime();
                    this.showLoadedQuestions();
                } else {
                    throw new Error('Hech qanday savol topilmadi');
                }
            }
            
            calculateTime() {
                const minutes = Math.ceil(this.questions.length / 10);
                this.totalTime = minutes * 60;
                this.timeLeft = this.totalTime;
                
                document.getElementById('loadedQuestionsCount').textContent = this.questions.length;
                document.getElementById('calculatedTime').textContent = minutes;
                this.totalQuestionsEl.textContent = this.questions.length;
                this.timerEl.textContent = this.formatTime(this.totalTime);
                this.timerCloneEl.textContent = this.formatTime(this.totalTime);
            }
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            showLoadedQuestions() {
                this.loadedQuestionsInfo.style.display = 'block';
                this.showToast('Muvaffaqiyatli', `${this.questions.length} ta savol yuklandi`);
                this.startBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            startQuiz() {
                this.startScreen.style.display = 'none';
                this.quizScreen.style.display = 'block';
                this.startTimer();
                this.showQuestion();
            }
            
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const formatted = this.formatTime(this.timeLeft);
                    this.timerEl.textContent = formatted;
                    this.timerCloneEl.textContent = formatted;
                    
                    if (this.timeLeft <= 60) {
                        document.getElementById('timer').classList.add('warning');
                        document.getElementById('timerClone').classList.add('warning');
                    }
                    if (this.timeLeft <= 0) {
                        this.endQuiz();
                    }
                }, 1000);
            }
            
            showQuestion() {
                const qIdx = this.questionOrder[this.currentQuestion];
                const question = this.questions[qIdx];
                
                this.questionContainer.innerHTML = `
                    <div class="question-container active">
                        <div class="question-card">
                            <div class="question-text">
                                ${question.question}
                            </div>
                            <div class="answers">
                                ${question.options.map((option, index) => `
                                    <div class="answer-option" data-index="${index}">
                                        ${option}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                const options = document.querySelectorAll('.answer-option');
                options.forEach(option => {
                    option.addEventListener('click', (e) => this.selectAnswer(e, qIdx));
                });
                
                this.updateProgress();
                
                if (this.userAnswers[qIdx] !== undefined) {
                    const sel = document.querySelector(`[data-index="${this.userAnswers[qIdx]}"]`);
                    if (sel) sel.classList.add('selected');
                }
            }
            
            selectAnswer(e, qIdx) {
                if (this.userAnswers[qIdx] !== undefined) return;
                
                const selectedIndex = parseInt(e.currentTarget.dataset.index);
                
                document.querySelectorAll('.answer-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                e.currentTarget.classList.add('selected');
                this.userAnswers[qIdx] = selectedIndex;
                
                setTimeout(() => {
                    this.nextQuestion();
                }, 400);
            }
            
            updateProgress() {
                const progress = ((this.currentQuestion + 1) / this.questions.length) * 100;
                this.progressBar.style.width = `${progress}%`;
                this.currentQuestionEl.textContent = this.currentQuestion + 1;
            }
            
            nextQuestion() {
                if (this.currentQuestion < this.questions.length - 1) {
                    this.currentQuestion++;
                    this.showQuestion();
                } else {
                    this.endQuiz();
                }
            }
            
            endQuiz() {
                clearInterval(this.timer);
                this.calculateScore();
                this.showResults();
            }
            
            calculateScore() {
                this.score = 0;
                for (let i = 0; i < this.questions.length; i++) {
                    const qIdx = this.questionOrder[i];
                    if (this.userAnswers[qIdx] === this.questions[qIdx].correct) {
                        this.score++;
                    }
                }
            }
            
            showResults() {
                this.quizScreen.style.display = 'none';
                this.resultScreen.style.display = 'block';
                
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const correctAnswers = this.score;
                const wrongAnswers = this.questions.length - this.score;
                
                document.getElementById('correctAnswers').textContent = correctAnswers;
                document.getElementById('wrongAnswers').textContent = wrongAnswers;
                document.getElementById('finalScore').textContent = `${percentage}%`;
                
                document.getElementById('summaryCorrect').textContent = correctAnswers;
                document.getElementById('summaryWrong').textContent = wrongAnswers;
                
                const resultBadge = document.getElementById('resultBadge');
                if (percentage >= 90) {
                    resultBadge.textContent = 'A\'lo! üèÜ';
                    resultBadge.className = 'result-badge result-excellent';
                } else if (percentage >= 70) {
                    resultBadge.textContent = 'Yaxshi! üëç';
                    resultBadge.className = 'result-badge result-good';
                } else if (percentage >= 50) {
                    resultBadge.textContent = 'O\'rtacha üòê';
                    resultBadge.className = 'result-badge result-average';
                } else {
                    resultBadge.textContent = 'Yaxshiroq harakat qiling üòû';
                    resultBadge.className = 'result-badge result-poor';
                }
                
                const reviewList = document.getElementById('reviewList');
                reviewList.innerHTML = '<h4 style="color: #2c2c2c; font-weight: 600; margin-bottom: 1.5rem;">Batafsil natijalar:</h4>';
                
                for (let disp = 0; disp < this.questions.length; disp++) {
                    const qIdx = this.questionOrder[disp];
                    const origQ = this.originalQuestions[qIdx];
                    const shuffledQ = this.questions[qIdx];
                    const userIdx = this.userAnswers[qIdx];
                    const correctIdx = shuffledQ.correct;
                    
                    const userOrigIdx = userIdx !== undefined ? this.shuffledIndices[qIdx][userIdx] : -1;
                    const userOrigLetter = userOrigIdx >= 0 ? String.fromCharCode(65 + userOrigIdx) : 'Tanlanmagan';
                    const correctOrigLetter = String.fromCharCode(65 + origQ.correct);
                    
                    let optionsHTML = '';
                    origQ.options.forEach((opt, oIdx) => {
                        let cls = '';
                        let icon = '';
                        
                        if (oIdx === origQ.correct) {
                            cls = 'review-correct';
                            icon = ' ‚úì';
                        }
                        
                        if (userOrigIdx === oIdx && userIdx !== undefined) {
                            if (oIdx === origQ.correct) {
                                cls = 'review-correct';
                            } else {
                                cls = 'review-incorrect';
                                icon = ' ‚úó';
                            }
                        }
                        
                        optionsHTML += `<div class="review-option ${cls}">${String.fromCharCode(65 + oIdx)}. ${opt}${icon}</div>`;
                    });
                    
                    const status = (userIdx === correctIdx) 
                        ? '<span style="color:#10b981; font-weight: 600;">To\'g\'ri</span>' 
                        : '<span style="color:#ef4444; font-weight: 600;">Noto\'g\'ri</span>';
                    
                    reviewList.innerHTML += `
                        <div class="review-question">
                            <div class="review-question-text">
                                Savol ${disp + 1}: ${origQ.question} 
                                <span style="float: right;">${status}</span>
                            </div>
                            <div class="review-options">
                                ${optionsHTML}
                                <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
                                    Sizning javobingiz: <strong>${userOrigLetter}</strong> | 
                                    To'g'ri javob: <strong style="color: #10b981;">${correctOrigLetter}</strong>
                                </small>
                            </div>
                        </div>
                    `;
                }
            }
            
            toggleFullReview() {
                const reviewList = document.getElementById('reviewList');
                if (reviewList.style.display === 'block') {
                    reviewList.style.display = 'none';
                    this.showMoreBtn.innerHTML = 'Ko\'proq ko\'rsatish <i class="fas fa-chevron-down"></i>';
                } else {
                    reviewList.style.display = 'block';
                    this.showMoreBtn.innerHTML = 'Kamroq ko\'rsatish <i class="fas fa-chevron-up"></i>';
                }
            }
            
            restartQuiz() {
                this.currentQuestion = 0;
                this.score = 0;
                this.userAnswers = [];
                this.timeLeft = this.totalTime;
                this.questionOrder = this.shuffleArray([...this.questionOrder]);
                this.shuffledIndices = [];
                
                this.questions = this.originalQuestions.map((q, idx) => {
                    const indices = [0,1,2,3];
                    const shuffled = this.shuffleArray([...indices]);
                    this.shuffledIndices[idx] = shuffled;
                    const shuffledOpts = shuffled.map(i => q.options[i]);
                    const newCorrect = shuffled.indexOf(q.correct);
                    return {
                        question: q.question,
                        options: shuffledOpts,
                        correct: newCorrect
                    };
                });
                
                if (this.timer) clearInterval(this.timer);
                
                const timers = [document.getElementById('timer'), document.getElementById('timerClone')];
                timers.forEach(t => t.classList.remove('warning'));
                
                this.resultScreen.style.display = 'none';
                this.quizScreen.style.display = 'block';
                this.startTimer();
                this.showQuestion();
            }
            
            newTest() {
                this.currentQuestion = 0;
                this.score = 0;
                this.userAnswers = [];
                this.questions = [];
                this.originalQuestions = [];
                this.shuffledIndices = [];
                this.questionOrder = [];
                if (this.timer) clearInterval(this.timer);
                
                const timers = [document.getElementById('timer'), document.getElementById('timerClone')];
                timers.forEach(t => t.classList.remove('warning'));
                
                this.resultScreen.style.display = 'none';
                this.startScreen.style.display = 'block';
                this.loadedQuestionsInfo.style.display = 'none';
                document.getElementById('reviewList').style.display = 'none';
                this.showMoreBtn.innerHTML = 'Ko\'proq ko\'rsatish <i class="fas fa-chevron-down"></i>';
                this.fileInput.value = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new QuizApp();
        });
    </script>
</body>
</html>
